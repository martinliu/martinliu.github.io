<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Elastic Stack on Martin Liu's Blog</title><link>https://martinliu.cn/tags/elastic-stack/</link><description>Recent content in Elastic Stack on Martin Liu's Blog</description><generator>Hugo -- gohugo.io</generator><language>zh-cn</language><lastBuildDate>Tue, 25 Jun 2024 21:44:26 +0800</lastBuildDate><atom:link href="https://martinliu.cn/tags/elastic-stack/index.xml" rel="self" type="application/rss+xml"/><item><title>Elastic Agent 和 Fleet 服务器 安装手册 v8.4</title><link>https://martinliu.cn/blog/elastic-agent-fleet-update-8-4/</link><pubDate>Tue, 18 Oct 2022 21:32:14 +0800</pubDate><guid>https://martinliu.cn/blog/elastic-agent-fleet-update-8-4/</guid><description>&lt;img src="https://martinliu.cn/blog/elastic-agent-fleet-update-8-4/observability.png" alt="Featured image of post Elastic Agent 和 Fleet 服务器 安装手册 v8.4" />&lt;p>测试过程和环境概述：&lt;/p>
&lt;ul>
&lt;li>用一个 RHEL 9 虚拟机安装 Elasticsearch 和 Kibana；然后部署 Fleet 服务器。&lt;/li>
&lt;li>在另外一个虚拟机安装 Elastic Agent，初始化注册到 Fleet 服务器，然后更新对它的管理策略。&lt;/li>
&lt;li>在 Kibana 的可观测性和安全解决方案中观察采集到的数据。&lt;/li>
&lt;/ul>
&lt;h2 id="安装-elasticsearch">安装 Elasticsearch
&lt;/h2>&lt;p>下载 Elasticsearch 的 rpm 安装包，用 rpm 的方式安装 Elasticssearch 服务器。 &lt;code>dnf install elasticsearch-8.4.3-x86_64.rpm &lt;/code>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;span class="lnt">57
&lt;/span>&lt;span class="lnt">58
&lt;/span>&lt;span class="lnt">59
&lt;/span>&lt;span class="lnt">60
&lt;/span>&lt;span class="lnt">61
&lt;/span>&lt;span class="lnt">62
&lt;/span>&lt;span class="lnt">63
&lt;/span>&lt;span class="lnt">64
&lt;/span>&lt;span class="lnt">65
&lt;/span>&lt;span class="lnt">66
&lt;/span>&lt;span class="lnt">67
&lt;/span>&lt;span class="lnt">68
&lt;/span>&lt;span class="lnt">69
&lt;/span>&lt;span class="lnt">70
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@elk8 ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># dnf install elasticsearch-8.4.3-x86_64.rpm &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Updating Subscription Management repositories.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Red Hat Enterprise Linux &lt;span class="m">9&lt;/span> &lt;span class="k">for&lt;/span> x86_64 - BaseOS &lt;span class="o">(&lt;/span>RPMs&lt;span class="o">)&lt;/span> 3.9 kB/s &lt;span class="p">|&lt;/span> 4.1 kB 00:01
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Red Hat Enterprise Linux &lt;span class="m">9&lt;/span> &lt;span class="k">for&lt;/span> x86_64 - AppStream &lt;span class="o">(&lt;/span>RPMs&lt;span class="o">)&lt;/span> 3.9 kB/s &lt;span class="p">|&lt;/span> 4.1 kB 00:01
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dependencies resolved.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=============================================================================================================================&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Package Architecture Version Repository &lt;span class="nv">Size&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=============================================================================================================================&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Installing:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> elasticsearch x86_64 8.4.3-1 @commandline &lt;span class="m">540&lt;/span> M
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Transaction &lt;span class="nv">Summary&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=============================================================================================================================&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Install &lt;span class="m">1&lt;/span> Package
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Total size: &lt;span class="m">540&lt;/span> M
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Installed size: 1.1 G
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Is this ok &lt;span class="o">[&lt;/span>y/N&lt;span class="o">]&lt;/span>: y
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Downloading Packages:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Running transaction check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Transaction check succeeded.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Running transaction &lt;span class="nb">test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Transaction &lt;span class="nb">test&lt;/span> succeeded.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Running transaction
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Preparing : 1/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Running scriptlet: elasticsearch-8.4.3-1.x86_64 1/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Creating elasticsearch group... OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Creating elasticsearch user... OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Installing : elasticsearch-8.4.3-1.x86_64 1/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Running scriptlet: elasticsearch-8.4.3-1.x86_64 1/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">--------------------------- Security autoconfiguration information ------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Authentication and authorization are enabled.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">TLS &lt;span class="k">for&lt;/span> the transport and HTTP layers is enabled and configured.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">The generated password &lt;span class="k">for&lt;/span> the elastic built-in superuser is : guJrLagKN5bsmUh72bha
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">If this node should join an existing cluster, you can reconfigure this with
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">&amp;#39;/usr/share/elasticsearch/bin/elasticsearch-reconfigure-node --enrollment-token &amp;lt;token-here&amp;gt;&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">after creating an enrollment token on your existing cluster.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">You can &lt;span class="nb">complete&lt;/span> the following actions at any time:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Reset the password of the elastic built-in superuser with
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">&amp;#39;/usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic&amp;#39;&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Generate an enrollment token &lt;span class="k">for&lt;/span> Kibana instances with
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="s1">&amp;#39;/usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana&amp;#39;&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Generate an enrollment token &lt;span class="k">for&lt;/span> Elasticsearch nodes with
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="s1">&amp;#39;/usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s node&amp;#39;&lt;/span>.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">-------------------------------------------------------------------------------------------------
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">### NOT starting on installation, please execute the following statements to configure elasticsearch service to start automatically using systemd&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sudo systemctl daemon-reload
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sudo systemctl &lt;span class="nb">enable&lt;/span> elasticsearch.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">### You can start elasticsearch service by executing&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> sudo systemctl start elasticsearch.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/lib/tmpfiles.d/elasticsearch.conf:1: Line references path below legacy directory /var/run/, updating /var/run/elasticsearch → /run/elasticsearch&lt;span class="p">;&lt;/span> please update the tmpfiles.d/ drop-in file accordingly.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Verifying : elasticsearch-8.4.3-1.x86_64 1/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Installed products updated.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Installed:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> elasticsearch-8.4.3-1.x86_64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Complete!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@elk8 ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># &lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>安装完毕之后，用 vi 编辑器打开 &lt;code>/etc/elasticsearch/elasticsearch.yml&lt;/code> 配置文件 ； 在这个默认配置文件中寻找类似这样的一行 &lt;code>cluster.initial_master_nodes: [&amp;quot;elk8&amp;quot;]&lt;/code> ；将这一行注释掉。&lt;/p>
&lt;p>然后在此配置文件的最下面增加下面这几行。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">cluster.name&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">homelab-elk8&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">discovery.type&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">single-node&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">network.host&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">0.0.0.0&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">xpack.security.authc.api_key.enabled&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="kc">true&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>启动 Elasticsearch 服务，并查看服务的状态。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">sudo systemctl daemon-reload
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl &lt;span class="nb">enable&lt;/span> elasticsearch.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl start elasticsearch.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl status elasticsearch
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在使用 ES 前，可以先修改ES服务初始化的内建用户密码，改成自己好记的安全可控密码。否则需要到 ES 的启动日志里寻找系统自动生产的管理员密码。&lt;/p>
&lt;p>运行 &lt;code>/usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic -i&lt;/code> 命令修改 ES 的管理员账号 elastic 的密码。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;span class="lnt">9
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@elk8 ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># /usr/share/elasticsearch/bin/elasticsearch-reset-password -u elastic -i&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">This tool will reset the password of the &lt;span class="o">[&lt;/span>elastic&lt;span class="o">]&lt;/span> user.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">You will be prompted to enter the password.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Please confirm that you would like to &lt;span class="k">continue&lt;/span> &lt;span class="o">[&lt;/span>y/N&lt;span class="o">]&lt;/span>y
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Enter password &lt;span class="k">for&lt;/span> &lt;span class="o">[&lt;/span>elastic&lt;span class="o">]&lt;/span>:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Re-enter password &lt;span class="k">for&lt;/span> &lt;span class="o">[&lt;/span>elastic&lt;span class="o">]&lt;/span>:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Password &lt;span class="k">for&lt;/span> the &lt;span class="o">[&lt;/span>elastic&lt;span class="o">]&lt;/span> user successfully reset.
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在启动 ES 服务前，打开后续测试所需要的防火墙端口。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">firewall-cmd --permanent --add-port&lt;span class="o">=&lt;/span>9200/tcp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">firewall-cmd --permanent --add-port&lt;span class="o">=&lt;/span>5601/tcp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">firewall-cmd --permanent --add-port&lt;span class="o">=&lt;/span>8220/tcp
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">firewall-cmd --reload
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在浏览器里访问 es 的访问网址 https://10.0.30.105:9200/ ，忽略关于证书的安全提示，输入上面所修改的 elastic 账户信息，测试是否可以正常登录。&lt;/p>
&lt;h2 id="安装-kibana">安装 Kibana
&lt;/h2>&lt;p>下载 Kibana 的 rpm 安装包到服务器，然后执行下面的安装命令&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@elk8 ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># dnf install kibana-8.4.3-x86_64.rpm &lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Updating Subscription Management repositories.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Last metadata expiration check: 0:22:56 ago on Sun &lt;span class="m">16&lt;/span> Oct &lt;span class="m">2022&lt;/span> 02:20:20 PM CST.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Dependencies resolved.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=======================================================================================================================================&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Package Architecture Version Repository &lt;span class="nv">Size&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=======================================================================================================================================&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Installing:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> kibana x86_64 8.4.3-1 @commandline &lt;span class="m">274&lt;/span> M
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Transaction &lt;span class="nv">Summary&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">=======================================================================================================================================&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Install &lt;span class="m">1&lt;/span> Package
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Total size: &lt;span class="m">274&lt;/span> M
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Installed size: &lt;span class="m">649&lt;/span> M
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Is this ok &lt;span class="o">[&lt;/span>y/N&lt;span class="o">]&lt;/span>: y
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Downloading Packages:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Running transaction check
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Transaction check succeeded.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Running transaction &lt;span class="nb">test&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Transaction &lt;span class="nb">test&lt;/span> succeeded.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Running transaction
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Preparing : 1/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Running scriptlet: kibana-8.4.3-1.x86_64 1/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Installing : kibana-8.4.3-1.x86_64 1/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Running scriptlet: kibana-8.4.3-1.x86_64 1/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Creating kibana group... OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Creating kibana user... OK
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Created Kibana keystore in /etc/kibana/kibana.keystore
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">/usr/lib/tmpfiles.d/elasticsearch.conf:1: Line references path below legacy directory /var/run/, updating /var/run/elasticsearch → /run/elasticsearch&lt;span class="p">;&lt;/span> please update the tmpfiles.d/ drop-in file accordingly.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> Verifying : kibana-8.4.3-1.x86_64 1/1
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Installed products updated.
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Installed:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> kibana-8.4.3-1.x86_64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">Complete!
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>在启动 Kiban 服务器之前，先需要创建 Kibana 需要的各种加密 key ，执行下面的命令。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">/usr/share/kibana/bin/kibana-encryption-keys generate
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">xpack.encryptedSavedObjects.encryptionKey: 2e71f1b16031c2b111b76276268dbf9e
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">xpack.reporting.encryptionKey: 84cb58b5e944fa9f65f73382384612a5
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">xpack.security.encryptionKey: c5ac5b306ee011838a67e2eaf4154dd0
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>记录以上三行配置参数，并增加2行新参数，将它们全部添加到 Kibana 默认的配置文件中。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yaml" data-lang="yaml">&lt;span class="line">&lt;span class="cl">&lt;span class="nt">server.host&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="m">0.0.0.0&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">server.publicBaseUrl&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="s2">&amp;#34;http://10.0.30.105:5601&amp;#34;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">xpack.encryptedSavedObjects.encryptionKey&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">2e71f1b16031c2b111b76276268dbf9e&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">xpack.reporting.encryptionKey&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">84cb58b5e944fa9f65f73382384612a5&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w">&lt;/span>&lt;span class="nt">xpack.security.encryptionKey&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="w"> &lt;/span>&lt;span class="l">c5ac5b306ee011838a67e2eaf4154dd0&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>用 vi 打开 Kibana 的默认配置文件 &lt;code>/etc/kibana/kibana.yml&lt;/code> ，将上面的 5 行配置参数添加到文件中。&lt;/p>
&lt;p>在命令行执行 &lt;code>systemctl enable --now kibana&lt;/code> 命令启动 Kibana 服务器.&lt;/p>
&lt;p>然后执行命令 &lt;code>tail -f /var/log/messages&lt;/code> ， 在日志中寻找 Kibana 服务启动的信息，等待出现 Kibana 配置的访问 URL。在日志中寻找类似这样的信息：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-json" data-lang="json">&lt;span class="line">&lt;span class="cl">&lt;span class="err">Oct&lt;/span> &lt;span class="mi">18&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="mi">36&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="mi">48&lt;/span> &lt;span class="err">elk&lt;/span>&lt;span class="mi">8&lt;/span> &lt;span class="err">kibana&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2163&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="err">i&lt;/span> &lt;span class="err">Kibana&lt;/span> &lt;span class="err">has&lt;/span> &lt;span class="err">not&lt;/span> &lt;span class="err">been&lt;/span> &lt;span class="err">configured.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">Oct&lt;/span> &lt;span class="mi">18&lt;/span> &lt;span class="mi">10&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="mi">36&lt;/span>&lt;span class="err">:&lt;/span>&lt;span class="mi">48&lt;/span> &lt;span class="err">elk&lt;/span>&lt;span class="mi">8&lt;/span> &lt;span class="err">kibana&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">2163&lt;/span>&lt;span class="p">]&lt;/span>&lt;span class="err">:&lt;/span> &lt;span class="err">Go&lt;/span> &lt;span class="err">to&lt;/span> &lt;span class="err">http:&lt;/span>&lt;span class="c1">//0.0.0.0:5601/?code=732948 to get started.
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>将 0.0.0.0 替换为这台虚拟机的 IP 地址，然后在浏览器中打开这个类似这个 &lt;code>http://10.0.30.105:5601/?code=732948&lt;/code> 网址。网页中会出现一个大输入框，等待输入Kibana 注册秘钥。&lt;/p>
&lt;p>在命令行执行 &lt;code>/usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana&lt;/code> 命令，从而获取 Kibana 的注册令牌。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@elk8 ~&lt;span class="o">]&lt;/span>&lt;span class="c1"># /usr/share/elasticsearch/bin/elasticsearch-create-enrollment-token -s kibana&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">eyJ2ZXIiOiI4LjQuMyIsImFkciI6WyIxOTIuMTY4LjEwLjEwOjkyMDAiXSwiZmdyIjoiZTdlOTdlZWU2YWVlYjVmYTczZWM1YTVkNzBiNDJkZGUzZjlkZmNjMDJhNTVmZDcwZjAxOTQwZmExNzE5YWM2MSIsImtleSI6IjNHLVEzNE1CYnA4c3p4TEZEZXpCOk0wUDMzRC1VVFAyT0ZxQVFBekNKSWcifQ&lt;/span>&lt;span class="o">==&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>将这个 Token 复制到网页里，完成Kibana 的初始化配置，最后用 es 的管理员账号登录 Kibana。&lt;/p>
&lt;p>从 kiban 目录中找到 es 的根 ca 证书，将其安装在系统的默认根证书目录中。查看 Kibana 的配置文件找到类似这样的一行配置信息。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">elasticsearch.ssl.certificateAuthorities: &lt;span class="o">[&lt;/span>/var/lib/kibana/ca_1666060779947.crt&lt;span class="o">]&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>运行下面的命令安装这个根证书。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">update-ca-trust &lt;span class="nb">enable&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">cp /var/lib/kibana/ca_1666060779947.crt /etc/pki/ca-trust/source/anchors/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">update-ca-trust extract
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>建议将这个根证书也用这个方法复制到其他需要用 Elastic Agent 采集监控数据的操作系统中，并安装备用。也可以在 Elastic Agent 安装的时候指定忽略 ES 证书校验的参数。&lt;/p>
&lt;h2 id="安装-fleet-服务器">安装 Fleet 服务器
&lt;/h2>&lt;p>在 Kibana 的菜单中找到， Fleet 选项，点击 Settings，然后点击 Edit Hosts ，选择增加 Fleet server 配置信息，输入 &lt;code>https://10.0.30.105:8220&lt;/code> ，注意这里必须是 https协议。&lt;/p>
&lt;p>回到 Fleet 主页，找到 agent 管理的地方，按照流程做，点击创建 Fleet Server 配置。然后就会在页面上生成 Fleet 服务器的安装配置命令。&lt;/p>
&lt;p>&lt;img src="https://martinliu.cn/blog/elastic-agent-fleet-update-8-4/2022-10-18_10-46-39.png"
width="1280"
height="1090"
srcset="https://martinliu.cn/blog/elastic-agent-fleet-update-8-4/2022-10-18_10-46-39_hu_3d0e290281eca0ee.png 480w, https://martinliu.cn/blog/elastic-agent-fleet-update-8-4/2022-10-18_10-46-39_hu_55ca710f9e4a41b3.png 1024w"
loading="lazy"
alt="Fleet server"
class="gallery-image"
data-flex-grow="117"
data-flex-basis="281px"
>&lt;/p>
&lt;p>按着提示的命令参数安装 Fleet 服务器。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;span class="lnt">7
&lt;/span>&lt;span class="lnt">8
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">curl -L -O https://artifacts.elastic.co/downloads/beats/elastic-agent/elastic-agent-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar xzvf elastic-agent-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> elastic-agent-8.4.3-linux-x86_64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo ./elastic-agent install &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --fleet-server-es&lt;span class="o">=&lt;/span>https://192.168.10.10:9200 &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --fleet-server-service-token&lt;span class="o">=&lt;/span>AAEAAWVsYXN0aWMvZmxlZXQtc2VydmVyL3Rva2VuLTE2NjU5MTM3ODg1NTA6aWdrR1pvNk9SWmk5N09tV3pUQktTUQ &lt;span class="se">\
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="se">&lt;/span> --fleet-server-policy&lt;span class="o">=&lt;/span>fleet-server-policy
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> --insecure
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>上面是连续四条安装命令，需要在最后一条命中，增加一个参数 &lt;code>--insecure&lt;/code> ；这样可以确保 Fleet 服务器的正常配置。&lt;/p>
&lt;p>在 Fleet 服务器正常启动以后，上面创建 Fleet 服务器配置的网页上的最后一步就会显示：Fleet 服务器已经连接正常，等待注册 Elastic Agent 。这样表明 Fleet 服务器已经安装正常，并且运行在默认的代理配置采集策略下。&lt;/p>
&lt;p>可以在 Kibana 的界面里查看 Fleet 服务器的监控信息。点击 Kibana 左上角的菜单：Observability -&amp;gt; Infrastructure -&amp;gt; Inventory ，即可看到 Fleet 服务器的监控数据。&lt;/p>
&lt;h2 id="安装-elastic-agent-监控代理">安装 Elastic Agent 监控代理
&lt;/h2>&lt;p>在 Fleet 的管理界面中新增一个名为 my-policy1 的管理策略，避免和 Fleet 服务器使用相同的策略。点击 Add agent 连接，获取如下代理注册命令。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">curl -L -O https://artifacts.elastic.co/downloads/beats/elastic-agent/elastic-agent-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar xzvf elastic-agent-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> elastic-agent-8.4.3-linux-x86_64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo ./elastic-agent install --url&lt;span class="o">=&lt;/span>https://10.0.30.105:8220 --enrollment-token&lt;span class="o">=&lt;/span>&lt;span class="nv">NW9ZTjZZTUJtUENhc0ZFTDI5SV86MkZQT1hlc2dUOEdWZnRrWWhNbXVjdw&lt;/span>&lt;span class="o">==&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>将上面的命令复制到一个写字板中，修改最后一条命令，在最后增加&lt;code>--insecure&lt;/code> 参数&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">./elastic-agent install --url&lt;span class="o">=&lt;/span>https://10.0.30.105:8220 --enrollment-token&lt;span class="o">=&lt;/span>&lt;span class="nv">NW9ZTjZZTUJtUENhc0ZFTDI5SV86MkZQT1hlc2dUOEdWZnRrWWhNbXVjdw&lt;/span>&lt;span class="o">==&lt;/span> --insecure
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>通过执行上面的命令，我们就在被管理服务器上，一键式的安装了用于数据采集功能的 Elastic Agent ，并将其注册到 Fleet 服务器上。你也可以手工下载好 &lt;code>elastic-agent-8.4.3-linux-x86_64.tar.gz &lt;/code> 文件，但是反复在多个被管理服务器上复制也很麻烦。&lt;/p>
&lt;h2 id="搭建本地安装包下载服务器">搭建本地安装包下载服务器
&lt;/h2>&lt;p>为了让局域网中的操作系统能就近下载 Elastic Stack 技术栈中，所有可以通过 Fleet 服务器管理（安装、配置、升级、删除等）的组件，我们可以参考文档的方法：https://www.elastic.co/guide/en/fleet/8.4/air-gapped.html#host-artifact-registry 在本地部署一个安装包下载服务器。&lt;/p>
&lt;p>首先，安装一个 Nginx 服务器，在根目录下创建目录 downloads ，并且运行下面的下载脚本。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/apm-server/apm-server-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/apm-server/apm-server-8.4.3-linux-x86_64.tar.gz.sha512
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/apm-server/apm-server-8.4.3-linux-x86_64.tar.gz.asc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/beats/auditbeat/auditbeat-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/beats/auditbeat/auditbeat-8.4.3-linux-x86_64.tar.gz.sha512
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/beats/auditbeat/auditbeat-8.4.3-linux-x86_64.tar.gz.asc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/beats/elastic-agent/elastic-agent-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/beats/elastic-agent/elastic-agent-8.4.3-linux-x86_64.tar.gz.sha512
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/beats/elastic-agent/elastic-agent-8.4.3-linux-x86_64.tar.gz.asc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.4.3-linux-x86_64.tar.gz.sha512
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/beats/filebeat/filebeat-8.4.3-linux-x86_64.tar.gz.asc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/beats/heartbeat/heartbeat-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/beats/heartbeat/heartbeat-8.4.3-linux-x86_64.tar.gz.sha512
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/beats/heartbeat/heartbeat-8.4.3-linux-x86_64.tar.gz.asc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-8.4.3-linux-x86_64.tar.gz.sha512
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/beats/metricbeat/metricbeat-8.4.3-linux-x86_64.tar.gz.asc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/beats/osquerybeat/osquerybeat-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/beats/osquerybeat/osquerybeat-8.4.3-linux-x86_64.tar.gz.sha512
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/beats/osquerybeat/osquerybeat-8.4.3-linux-x86_64.tar.gz.asc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/beats/packetbeat/packetbeat-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/beats/packetbeat/packetbeat-8.4.3-linux-x86_64.tar.gz.sha512
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/beats/packetbeat/packetbeat-8.4.3-linux-x86_64.tar.gz.asc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/cloudbeat/cloudbeat-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/cloudbeat/cloudbeat-8.4.3-linux-x86_64.tar.gz.sha512
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/cloudbeat/cloudbeat-8.4.3-linux-x86_64.tar.gz.asc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/endpoint-dev/endpoint-security-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/endpoint-dev/endpoint-security-8.4.3-linux-x86_64.tar.gz.sha512
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/endpoint-dev/endpoint-security-8.4.3-linux-x86_64.tar.gz.asc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/fleet-server/fleet-server-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/fleet-server/fleet-server-8.4.3-linux-x86_64.tar.gz.sha512
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">curl -O https://artifacts.elastic.co/downloads/fleet-server/fleet-server-8.4.3-linux-x86_64.tar.gz.asc
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>将下载后的目录结构整理的和下载路径一致，目录结构如下所示：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@elk8 html&lt;span class="o">]&lt;/span>&lt;span class="c1"># tree downloads/&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">downloads/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── apm-server
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ ├── apm-server-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ ├── apm-server-8.4.3-linux-x86_64.tar.gz.asc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ └── apm-server-8.4.3-linux-x86_64.tar.gz.sha512
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── beats
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ ├── auditbeat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ │ ├── auditbeat-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ │ ├── auditbeat-8.4.3-linux-x86_64.tar.gz.asc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ │ └── auditbeat-8.4.3-linux-x86_64.tar.gz.sha512
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ ├── elastic-agent
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ │ ├── elastic-agent-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ │ ├── elastic-agent-8.4.3-linux-x86_64.tar.gz.asc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ │ └── elastic-agent-8.4.3-linux-x86_64.tar.gz.sha512
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ ├── filebeat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ │ ├── filebeat-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ │ ├── filebeat-8.4.3-linux-x86_64.tar.gz.asc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ │ └── filebeat-8.4.3-linux-x86_64.tar.gz.sha512
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ ├── heartbeat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ │ ├── heartbeat-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ │ ├── heartbeat-8.4.3-linux-x86_64.tar.gz.asc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ │ └── heartbeat-8.4.3-linux-x86_64.tar.gz.sha512
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ ├── metricbeat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ │ ├── metricbeat-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ │ ├── metricbeat-8.4.3-linux-x86_64.tar.gz.asc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ │ └── metricbeat-8.4.3-linux-x86_64.tar.gz.sha512
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ ├── osquerybeat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ │ ├── osquerybeat-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ │ ├── osquerybeat-8.4.3-linux-x86_64.tar.gz.asc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ │ └── osquerybeat-8.4.3-linux-x86_64.tar.gz.sha512
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ └── packetbeat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ ├── packetbeat-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ ├── packetbeat-8.4.3-linux-x86_64.tar.gz.asc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ └── packetbeat-8.4.3-linux-x86_64.tar.gz.sha512
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── cloudbeat
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ ├── cloudbeat-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ ├── cloudbeat-8.4.3-linux-x86_64.tar.gz.asc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ └── cloudbeat-8.4.3-linux-x86_64.tar.gz.sha512
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── endpoint-dev
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ ├── endpoint-security-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ ├── endpoint-security-8.4.3-linux-x86_64.tar.gz.asc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ └── endpoint-security-8.4.3-linux-x86_64.tar.gz.sha512
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">├── fleet-server
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ ├── fleet-server-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ ├── fleet-server-8.4.3-linux-x86_64.tar.gz.asc
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">│ └── fleet-server-8.4.3-linux-x86_64.tar.gz.sha512
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">└── pull-bin.sh
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="m">12&lt;/span> directories, &lt;span class="m">34&lt;/span> files
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">[&lt;/span>root@elk8 html&lt;span class="o">]&lt;/span>&lt;span class="c1"># &lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>为了方便查看这个目录的内容，修改 nginx 的默认配置文件，在 http 这个部分增加下面三个参数：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-yml" data-lang="yml">&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">autoindex on; &lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">autoindex_exact_size off;&lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="w"> &lt;/span>&lt;span class="l">autoindex_localtime on; &lt;/span>&lt;span class="w">
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>重启 Nginix 服务器后，在浏览器中可以访问： http://192.168.10.10/downloads/ ，确保可以看到正确的目录结构和文件。&lt;/p>
&lt;p>进入 Fleet 的配置页面，在 &lt;code>Agent Binary Download&lt;/code> 下面点击 “Add agent binary source” ，新建一个新的代理安装包下载来源网站。&lt;/p>
&lt;p>&lt;img src="https://martinliu.cn/blog/elastic-agent-fleet-update-8-4/2022-10-18_14-21-44.png"
width="1920"
height="1436"
srcset="https://martinliu.cn/blog/elastic-agent-fleet-update-8-4/2022-10-18_14-21-44_hu_c95d59291820b55d.png 480w, https://martinliu.cn/blog/elastic-agent-fleet-update-8-4/2022-10-18_14-21-44_hu_2bf663dfb53b4dea.png 1024w"
loading="lazy"
alt="Agent Binary Download"
class="gallery-image"
data-flex-grow="133"
data-flex-basis="320px"
>&lt;/p>
&lt;p>在 Agent Policies 页面新建一个新的测试用 Agent 管理策略，名为 “my-policy2”；进入这个策略的配置界面，修改 &lt;em>Agent Binary Download&lt;/em> 为刚才创建的下载源。保存并测试这个策略。&lt;/p>
&lt;p>&lt;img src="https://martinliu.cn/blog/elastic-agent-fleet-update-8-4/2022-10-18_14-25-35.png"
width="1920"
height="1860"
srcset="https://martinliu.cn/blog/elastic-agent-fleet-update-8-4/2022-10-18_14-25-35_hu_e9e762737e6eae10.png 480w, https://martinliu.cn/blog/elastic-agent-fleet-update-8-4/2022-10-18_14-25-35_hu_5a9d2e0438907373.png 1024w"
loading="lazy"
class="gallery-image"
data-flex-grow="103"
data-flex-basis="247px"
>&lt;/p>
&lt;p>点击 “Add agent” 连接，获取下面的新注册代理注册命令。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">curl -L -O https://artifacts.elastic.co/downloads/beats/elastic-agent/elastic-agent-8.4.3-linux-x86_64.tar.gz tar xzvf elastic-agent-8.4.3-linux-x86_64.tar.gz &lt;span class="nb">cd&lt;/span> elastic-agent-8.4.3-linux-x86_64 sudo ./elastic-agent install --url&lt;span class="o">=&lt;/span>https://10.0.30.105:8220 --enrollment-token&lt;span class="o">=&lt;/span>&lt;span class="nv">R29qRDZZTUJtUENhc0ZFTFNDSW06bVFOeW5vcUpTQmFmZDBwLUgyTDBYZw&lt;/span>&lt;span class="o">==&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>修改这些命令参数，如下：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-shell" data-lang="shell">&lt;span class="line">&lt;span class="cl">curl -L -O http://192.168.10.10/downloads/beats/elastic-agent/elastic-agent-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">tar xzvf elastic-agent-8.4.3-linux-x86_64.tar.gz
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">cd&lt;/span> elastic-agent-8.4.3-linux-x86_64
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo ./elastic-agent install --url&lt;span class="o">=&lt;/span>https://10.0.30.105:8220 --enrollment-token&lt;span class="o">=&lt;/span>&lt;span class="nv">R29qRDZZTUJtUENhc0ZFTFNDSW06bVFOeW5vcUpTQmFmZDBwLUgyTDBYZw&lt;/span>&lt;span class="o">==&lt;/span> --insecure
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>SSH 登录到另外一个虚拟机，用新创建的 Agent 管理策略，一键式安装 Elastic Agent 并注册到 Fleet 服务器。由于这个策略使用了本地的安装包（默认会使用到 Filebeat 和 Metricbeat），所以它的部署速度应该会比较快。&lt;/p>
&lt;p>在 Elastic Agent 的日志文件中应该可以看到类似这样的信息。&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-sh" data-lang="sh">&lt;span class="line">&lt;span class="cl">cat /opt/Elastic/Agent/elastic-agent-20221018.ndjson
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="sb">```&lt;/span>json
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;log.level&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;info&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;@timestamp&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;2022-10-18T14:37:26.697+0800&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;log.origin&amp;#34;&lt;/span>:&lt;span class="o">{&lt;/span>&lt;span class="s2">&amp;#34;file.name&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;artifact/config.go&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;file.line&amp;#34;&lt;/span>:138&lt;span class="o">}&lt;/span>,&lt;span class="s2">&amp;#34;message&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;Source URI changed from \&amp;#34;https://artifacts.elastic.co/downloads/\&amp;#34; to \&amp;#34;http://192.168.10.10/downloads/\&amp;#34;&amp;#34;&lt;/span>,&lt;span class="s2">&amp;#34;ecs.version&amp;#34;&lt;/span>:&lt;span class="s2">&amp;#34;1.6.0&amp;#34;&lt;/span>&lt;span class="o">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这个信息表示：当前的 Agent 会使用上面自建的安装包下载源服务器。&lt;/p>
&lt;p>用这个命令 &lt;code>elastic-agent inspect&lt;/code> 也可以确认这个配置。&lt;/p>
&lt;h2 id="万用采集端的好处">万用采集端的好处
&lt;/h2>&lt;p>在上一篇文章中已经说过了这个问题，这里不赘述。&lt;/p>
&lt;p>为了验证这个功能，可以尝试更新当前的一个 policy，增加 Packetbeat 数据采集能力。操作步骤如下：&lt;/p>
&lt;ol>
&lt;li>打开当前的一个正在使用中 policy&lt;/li>
&lt;li>点击 Add intergation 按钮，在众多选项中选择 Network Packet Capture 模块。&lt;/li>
&lt;li>增加新的采集模块后，保存这个策略。&lt;/li>
&lt;li>它更新了版本，观察 Fleet 界面上所有使用这个策略的节点的状态变化。&lt;/li>
&lt;li>这些节点会自动的，很快的更新到新的管理策略中，Elastic Agent 会自动化安装 Packetbeat 采集模块。&lt;/li>
&lt;li>返回 Kiban ，进入安全管理解决方案，我们可以看到 Filebeat 和 Packetbeat 的采集结果。&lt;/li>
&lt;/ol>
&lt;p>&lt;img src="https://martinliu.cn/blog/elastic-agent-fleet-update-8-4/2022-10-18_22-49-08.png"
width="1920"
height="817"
srcset="https://martinliu.cn/blog/elastic-agent-fleet-update-8-4/2022-10-18_22-49-08_hu_63b82c96a00d5d41.png 480w, https://martinliu.cn/blog/elastic-agent-fleet-update-8-4/2022-10-18_22-49-08_hu_78045171d2680604.png 1024w"
loading="lazy"
alt="添加 Packetbeat 模块"
class="gallery-image"
data-flex-grow="235"
data-flex-basis="564px"
>&lt;/p>
&lt;p>在策略更新了以后，我们没有在 Elastic Agent 端做任何操作，它就已经自动化的下载新的策略，并更新了自身。&lt;/p>
&lt;p>&lt;img src="https://martinliu.cn/blog/elastic-agent-fleet-update-8-4/2022-10-18_22-53-55.png"
width="1920"
height="1675"
srcset="https://martinliu.cn/blog/elastic-agent-fleet-update-8-4/2022-10-18_22-53-55_hu_677fb959b954497d.png 480w, https://martinliu.cn/blog/elastic-agent-fleet-update-8-4/2022-10-18_22-53-55_hu_af73df2f5290255.png 1024w"
loading="lazy"
alt="查看 安全管理解决方案"
class="gallery-image"
data-flex-grow="114"
data-flex-basis="275px"
>&lt;/p>
&lt;h2 id="常见问题">常见问题
&lt;/h2>&lt;p>Elastic Agent 在采集数据的服务上安装正常，在 Fleet 服务器的管理界面中也可以看到其状态正常。但是在可观测性的页面中看不到它的任何数据。&lt;/p>
&lt;p>可能的原因：Elastic Agent 采集端程序和 ES 后台服务器的通讯不正常，检查 9200 端口，用 curl + ES 服务器端的数字证书，用户名和密码，尝试访问 ES 的服务地址 &lt;code>https://192.168.10.10:9200&lt;/code>。&lt;/p>
&lt;p>也可以尝试在 Fleet 的管理页面上删除这个 Agent；然后在被管理服务器上，用命令 &lt;code>elastic-agent uninstall&lt;/code> 删除服务，然后重新安装注册这个被管理服务器，注意在注册命令的最后面可以尝试增加这两个参数：&lt;code> --insecure --fleet-server-es-insecure&lt;/code> 第一个参数是忽略 Fleet 服务器的 ssl 证书校验，第二个参数是忽略 es 服务器的 ssl 证书校验。或者尝试重新手工安装一遍 es 服务器上的 ca 根证书。&lt;/p>
&lt;p>Feature picture ❤️ Brett Sayles图片: &lt;a class="link" href="https://www.pexels.com/zh-cn/photo/2881224/" target="_blank" rel="noopener"
>https://www.pexels.com/zh-cn/photo/2881224/&lt;/a>&lt;/p></description></item><item><title>面向未来的 Elastic Stack 数据摄入架构</title><link>https://martinliu.cn/blog/fleet-and-elastic-agent/</link><pubDate>Mon, 17 Oct 2022 21:09:52 +0800</pubDate><guid>https://martinliu.cn/blog/fleet-and-elastic-agent/</guid><description>&lt;img src="https://martinliu.cn/blog/fleet-and-elastic-agent/pexels-analogicus-5516029.jpg" alt="Featured image of post 面向未来的 Elastic Stack 数据摄入架构" />&lt;h2 id="数据摄入的痛点">数据摄入的痛点
&lt;/h2>&lt;p>安装、升级和维护各种数据采集工具，包括 Filebeat、Metricbeat、APM 埋点、Logstash数据重整转发、端点安全控制，还有很多很多其它功能选项，貌似每增加一丁点功能，以前的数据采集项目又要重新再来一遍。&lt;/p>
&lt;p>采集管理的配置文件不光只是 YAML 文件，越写越长的 YAML 文件渐渐将你带入了十八层地狱。&lt;/p>
&lt;p>在每个端点上启用和配置不同采集模块行为参数，很多情况下，你不得不在大量采集点的命令行里执行配置命令。&lt;/p>
&lt;p>不同采集模块在采集节点上都需要创建新的用户，不仅复杂化了操作系统用户的管理，还可能引入更多的风险。&lt;/p>
&lt;p>自动化配置管理工具可以批量分发和部署这些数据摄入配置文件，但是你又不得不为此学习另外一种新的武功。&lt;/p>
&lt;h2 id="优化的方向">优化的方向
&lt;/h2>&lt;h3 id="简化采集端部署">简化采集端部署
&lt;/h3>&lt;p>下面是 Elastic Agent 所实现的效果。减少采集不同类型数据的采集代理程序的种类，最好能只使用一个全功能的采集代理程序；有可能的话用一种万能的采集代理程序替代所有单点采集程序，诸如：Filebeat， Metricbeat， APM Agent， Heartbeat， Winlogbeat 等等各种 Elastic Stack 的采集程序。其他的这种类型的各个厂商和各种开源工具你可以自己联想。&lt;/p>
&lt;p>尽量发挥万能型采集代理程序的特性，最好它能够一键式的安装，能支持上百种流行的开源软件、商业软件和云服务。&lt;/p>
&lt;p>在采集代理程序开始正常工作以后，避免在端点的命令做任何配置工作。&lt;/p>
&lt;p>以上的数据采集端点程序部署在大多数情况下，都是覆盖可观测性解决方案的需求；如果可能的话，能够兼顾信息安全管理需求是一种更高效的做法；如果能一石二鸟，那又何乐而不为呢。&lt;/p>
&lt;h3 id="直观的集中统一管理">直观的集中统一管理
&lt;/h3>&lt;p>使用一个统一的采集代理管理中间层 Fleet 掌控全局。在这里一站式的实现采集代理的配置分发、更新等变更；实现采集代理程序的持续版本升级；随着采集端点数量的蔓延，横向扩展 Fleet 层，用一个 Fleet 服务器对接分布在各地的数千个 Elastic Agent。&lt;/p>
&lt;h2 id="elk-数据摄入架构变迁">ELK 数据摄入架构变迁
&lt;/h2>&lt;p>7.13 的 ELK 架构是持续了很久的传统模式，是社区里存在着大量描述文章，本文忽略对其的解释。&lt;/p>
&lt;p>渐进式的架构变化是从 7.13 开始初具雏形的，Fleet 功能组件作为 Kibana 的内置功能，正式登场。&lt;/p>
&lt;p>&lt;img src="https://martinliu.cn/blog/fleet-and-elastic-agent/2022-10-17_23-34-49.png"
width="1986"
height="872"
srcset="https://martinliu.cn/blog/fleet-and-elastic-agent/2022-10-17_23-34-49_hu_bcf44bb01c006b92.png 480w, https://martinliu.cn/blog/fleet-and-elastic-agent/2022-10-17_23-34-49_hu_ad85e7c2a9c14f85.png 1024w"
loading="lazy"
alt="7.13 前的架构图"
class="gallery-image"
data-flex-grow="227"
data-flex-basis="546px"
>&lt;/p>
&lt;p>Kiban 的定位是作为 Elastic Stack 的数据探索窗口，和管理控制平面。统一管理 Elastic Agent 需要增加两个功能：策略管理器和配置包管理器。需要引入新的 Fleet 服务器实现下面的需求：&lt;/p>
&lt;ul>
&lt;li>对 n 多采集点的更小暴露平面。&lt;/li>
&lt;li>降低了 Kibana 服务器本身资源消耗和部署工作量。&lt;/li>
&lt;li>更容易管理并发模式。&lt;/li>
&lt;/ul>
&lt;p>从 7.14 以后的架构图如下。这是以后的发展方向。&lt;/p>
&lt;p>&lt;img src="https://martinliu.cn/blog/fleet-and-elastic-agent/2022-10-17_23-36-03.png"
width="2062"
height="880"
srcset="https://martinliu.cn/blog/fleet-and-elastic-agent/2022-10-17_23-36-03_hu_3d0be2e26c47d2db.png 480w, https://martinliu.cn/blog/fleet-and-elastic-agent/2022-10-17_23-36-03_hu_24d33c01084562d2.png 1024w"
loading="lazy"
alt="7.14 后的架构图"
class="gallery-image"
data-flex-grow="234"
data-flex-basis="562px"
>&lt;/p>
&lt;p>Fleet 服务器的代码和 Elastic Agent 是一套程序。它就像是一个万能工具一样。&lt;/p>
&lt;p>它在对底层的采集端点上，实现的是全能型代理程序的管理。他在 Fleet 这个模式的主要功能是：从 Elasticsearch 后端或许最新版的 Agent 管理策略；相应采集端点上采集代理的管理策略拉取请求。管理策略的单向下发，采集数据的单向上传可以有几个选项，或者集中目标：&lt;/p>
&lt;ol>
&lt;li>自己部署管理的 Elasticsearch 集群&lt;/li>
&lt;li>自己部署管理的 Logstash 服务器&lt;/li>
&lt;li>Elastic Cloud SaaS 服务里的 Elasticsearch 服务端点&lt;/li>
&lt;li>Elastic Cloud SaaS 服务里的 Logstash 服务端点&lt;/li>
&lt;/ol>
&lt;p>Elastic Agent 采集端进程管理所有其他 Beats 进程，使用 GRPC 通讯协议发送数据，和下拉管理策略更新。&lt;/p>
&lt;p>Elastic Agent 可以工作在被 Fleet 服务器统一管理的模式；也还可以运行在独立自管理状态，从而满足极端少量的特殊需求。&lt;/p>
&lt;p>其他周边的重要组件：&lt;/p>
&lt;ol>
&lt;li>Elastic Package Registry - 包含了 Elastic Stack 技术栈中所有组件的配置细节，包括安装、升级、更新和删除等等。用 zip 压缩包文件的方式分发。&lt;/li>
&lt;li>Policy Builder - 在 Kibana 的界面里展现所有可以让用户掌控/修改定制的配置细节，用简单的开关按钮和输入框完成不容易出错的采集配置细节的定制，这样就消除了对 YAML 配置文件的管理。&lt;/li>
&lt;/ol>
&lt;p>参考信息：&lt;/p>
&lt;ul>
&lt;li>&lt;a class="link" href="https://www.elastic.co/guide/en/fleet/current/index.html" target="_blank" rel="noopener"
>Fleet and Elastic Agent Guide&lt;/a>&lt;/li>
&lt;li>&lt;a class="link" href="https://www.elastic.co/blog/review-testing-methods-for-elastic-integrations-using-the-elastic-package-tool" target="_blank" rel="noopener"
>Review testing methods for Elastic integrations using the elastic-package tool&lt;/a>&lt;/li>
&lt;/ul>
&lt;p>Feature picture ❤️ analogicus图片: &lt;a class="link" href="https://www.pexels.com/zh-cn/photo/5516029/" target="_blank" rel="noopener"
>https://www.pexels.com/zh-cn/photo/5516029/&lt;/a>&lt;/p></description></item><item><title>Elasticsearch 3 节点集群搭建 (7.9.0)</title><link>https://martinliu.cn/blog/elasticsearch-3-nodes-cluster-setup/</link><pubDate>Thu, 27 Aug 2020 13:54:46 +0800</pubDate><guid>https://martinliu.cn/blog/elasticsearch-3-nodes-cluster-setup/</guid><description>&lt;img src="https://martinliu.cn/images/abstract-6.jpg" alt="Featured image of post Elasticsearch 3 节点集群搭建 (7.9.0)" />&lt;p>最近发布的 Elastic Stack 7.9 ，带来了很多新的特性。Elastic Agent 统一集成数据采集代理是一大亮点。另外还看增加了企业搜索、端点安全防护等组件。Ingest Manager 统一 Beat 配置管理功能让我们向 SaaS 风格的监控工具又迈进了一步。由代理端自行注册到后端，在后端统一纳管所有被管理服务器，将是一种以后非常通用的模式。这样做的好处是：将数据采集端点的配置工作量和复杂度降低到最低。Beats 的各种相关独立模块也在平行的发布，这种双轨模式也可以让用户更弹性的做出选择，能最大程度的保持旧版本部署环境管理模式的延续性。 Ingest manager 的前提条件是：后台 ES 需要启用 api key 安全，启用 ES 客户端的 HTTPS 访问。我们也可以看到这两个功能选项也有其非常广泛的应用需求。本文将用最简单的文字，向你描述一套 3 节点的 ES 集群的搭建方式，这套系统的核心特性如下：&lt;/p>
&lt;ul>
&lt;li>启用用户名和密码认证&lt;/li>
&lt;li>启用集群内 es 节点间 transport.ssl 通讯加密&lt;/li>
&lt;li>启用 es 的 http 客户端 http.ssl 加密通讯&lt;/li>
&lt;li>安装脚本中包括创建数字证书的必要命令（没猜错的话，大部分人可能会在这一步花费大量时间）&lt;/li>
&lt;/ul>
&lt;h2 id="演示环境介绍">演示环境介绍
&lt;/h2>&lt;p>我使用的是本地的测试环境，环境配置如下：&lt;/p>
&lt;ul>
&lt;li>Mac OS&lt;/li>
&lt;li>vagrant&lt;/li>
&lt;li>virtualBox - CentOS 8&lt;/li>
&lt;li>Elastic Stack 7.9.0&lt;/li>
&lt;li>ip 和主机名分配见 Vagrantfile 文件&lt;/li>
&lt;li>Vagrant 的 vagrant-hostsupdater 插件实现了 Mac OS 主机和所有虚拟机的 host 文件 DNS 解析的同步，保证所有相关虚拟机都可以解析其它虚拟机的 FQDN，尽量模拟生产环境。&lt;/li>
&lt;/ul>
&lt;p>本文所使用的所有配置文件和安装脚本见：&lt;a class="link" href="https://github.com/DevOps-Coach/elasticstack.git" target="_blank" rel="noopener"
>https://github.com/DevOps-Coach/elasticstack.git&lt;/a>&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="err">➜&lt;/span> &lt;span class="n">elasticstack&lt;/span> &lt;span class="n">git&lt;/span>&lt;span class="p">:(&lt;/span>&lt;span class="n">master&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="err">✗&lt;/span> &lt;span class="n">vagrant&lt;/span> &lt;span class="n">up&lt;/span> &lt;span class="n">es1&lt;/span> &lt;span class="n">es2&lt;/span> &lt;span class="n">es3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Bringing&lt;/span> &lt;span class="n">machine&lt;/span> &lt;span class="s1">&amp;#39;es1&amp;#39;&lt;/span> &lt;span class="n">up&lt;/span> &lt;span class="n">with&lt;/span> &lt;span class="s1">&amp;#39;virtualbox&amp;#39;&lt;/span> &lt;span class="n">provider&lt;/span>&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Bringing&lt;/span> &lt;span class="n">machine&lt;/span> &lt;span class="s1">&amp;#39;es2&amp;#39;&lt;/span> &lt;span class="n">up&lt;/span> &lt;span class="n">with&lt;/span> &lt;span class="s1">&amp;#39;virtualbox&amp;#39;&lt;/span> &lt;span class="n">provider&lt;/span>&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Bringing&lt;/span> &lt;span class="n">machine&lt;/span> &lt;span class="s1">&amp;#39;es3&amp;#39;&lt;/span> &lt;span class="n">up&lt;/span> &lt;span class="n">with&lt;/span> &lt;span class="s1">&amp;#39;virtualbox&amp;#39;&lt;/span> &lt;span class="n">provider&lt;/span>&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&amp;gt;&lt;/span> &lt;span class="n">es1&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Importing&lt;/span> &lt;span class="n">base&lt;/span> &lt;span class="n">box&lt;/span> &lt;span class="s1">&amp;#39;bento/centos-8&amp;#39;&lt;/span>&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&amp;gt;&lt;/span> &lt;span class="n">es1&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Matching&lt;/span> &lt;span class="n">MAC&lt;/span> &lt;span class="n">address&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">NAT&lt;/span> &lt;span class="n">networking&lt;/span>&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="o">==&amp;gt;&lt;/span> &lt;span class="n">es1&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Checking&lt;/span> &lt;span class="k">if&lt;/span> &lt;span class="n">box&lt;/span> &lt;span class="s1">&amp;#39;bento/centos-8&amp;#39;&lt;/span> &lt;span class="n">version&lt;/span> &lt;span class="s1">&amp;#39;202002.04.0&amp;#39;&lt;/span> &lt;span class="n">is&lt;/span> &lt;span class="n">up&lt;/span> &lt;span class="n">to&lt;/span> &lt;span class="n">date&lt;/span>&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="err">省略中间大量输出。。。。。。&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">es3&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="err">●&lt;/span> &lt;span class="n">elasticsearch&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">service&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">Elasticsearch&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">es3&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Loaded&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">loaded&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">systemd&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">system&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">elasticsearch&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">service&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">enabled&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="n">vendor&lt;/span> &lt;span class="n">preset&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">disabled&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">es3&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Active&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">active&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">running&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="n">since&lt;/span> &lt;span class="n">Thu&lt;/span> &lt;span class="mi">2020&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">08&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">27&lt;/span> &lt;span class="mi">05&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">55&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">21&lt;/span> &lt;span class="n">UTC&lt;/span>&lt;span class="p">;&lt;/span> &lt;span class="mi">223&lt;/span>&lt;span class="n">ms&lt;/span> &lt;span class="n">ago&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">es3&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Docs&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="n">www&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">elastic&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">co&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">es3&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Main&lt;/span> &lt;span class="n">PID&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">4205&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">java&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">es3&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Tasks&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">41&lt;/span> &lt;span class="p">(&lt;/span>&lt;span class="n">limit&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mi">11499&lt;/span>&lt;span class="p">)&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">es3&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Memory&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="mf">1.2&lt;/span>&lt;span class="n">G&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">es3&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">CGroup&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">system&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">slice&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">elasticsearch&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">service&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">es3&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="err">├─&lt;/span>&lt;span class="mi">4205&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">share&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">elasticsearch&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">jdk&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">bin&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">java&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Xshare&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">auto&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Des&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">networkaddress&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cache&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ttl&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">60&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Des&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">networkaddress&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">cache&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">negative&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ttl&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">10&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">XX&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="n">AlwaysPreTouch&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Xss1m&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Djava&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">awt&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">headless&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="bp">true&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Dfile&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">encoding&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">UTF&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">8&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Djna&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">nosys&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="bp">true&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">XX&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">OmitStackTraceInFastThrow&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">XX&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="n">ShowCodeDetailsInExceptionMessages&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Dio&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">netty&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">noUnsafe&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="bp">true&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Dio&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">netty&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">noKeySetOptimization&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="bp">true&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Dio&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">netty&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">recycler&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">maxCapacityPerThread&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Dio&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">netty&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">allocator&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">numDirectArenas&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">0&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Dlog4j&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">shutdownHookEnabled&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="bp">false&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Dlog4j2&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">disable&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">jmx&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="bp">true&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Djava&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">locale&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">providers&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">SPI&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">COMPAT&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Xms1g&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Xmx1g&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">XX&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="n">UseG1GC&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">XX&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">G1ReservePercent&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">25&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">XX&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">InitiatingHeapOccupancyPercent&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">30&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Djava&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">io&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">tmpdir&lt;/span>&lt;span class="o">=/&lt;/span>&lt;span class="n">tmp&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">elasticsearch&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="mi">14730718416313121303&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">XX&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="n">HeapDumpOnOutOfMemoryError&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">XX&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">HeapDumpPath&lt;/span>&lt;span class="o">=/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">elasticsearch&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">XX&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">ErrorFile&lt;/span>&lt;span class="o">=/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nb">log&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">elasticsearch&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">hs_err_pid&lt;/span>&lt;span class="o">%&lt;/span>&lt;span class="n">p&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">log&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Xlog&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">gc&lt;/span>&lt;span class="o">*&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">gc&lt;/span>&lt;span class="o">+&lt;/span>&lt;span class="n">age&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">trace&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">safepoint&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">file&lt;/span>&lt;span class="o">=/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nb">log&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">elasticsearch&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">gc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">log&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">utctime&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">pid&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">tags&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">filecount&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">32&lt;/span>&lt;span class="p">,&lt;/span>&lt;span class="n">filesize&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">64&lt;/span>&lt;span class="n">m&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">XX&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="n">MaxDirectMemorySize&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="mi">536870912&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Des&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">home&lt;/span>&lt;span class="o">=/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">share&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">elasticsearch&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Des&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">conf&lt;/span>&lt;span class="o">=/&lt;/span>&lt;span class="n">etc&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">elasticsearch&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Des&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">distribution&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">flavor&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">default&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Des&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">distribution&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">type&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="n">rpm&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">Des&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">bundled_jdk&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="bp">true&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">cp&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">share&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">elasticsearch&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/*&lt;/span> &lt;span class="n">org&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">elasticsearch&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">bootstrap&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">Elasticsearch&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">p&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">run&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">elasticsearch&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">elasticsearch&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">pid&lt;/span> &lt;span class="o">--&lt;/span>&lt;span class="n">quiet&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">es3&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="err">└─&lt;/span>&lt;span class="mi">4360&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="n">usr&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">share&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">elasticsearch&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">modules&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">x&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">pack&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">ml&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">platform&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">linux&lt;/span>&lt;span class="o">-&lt;/span>&lt;span class="n">x86_64&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">bin&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">controller&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">es3&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">es3&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Aug&lt;/span> &lt;span class="mi">27&lt;/span> &lt;span class="mi">05&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">54&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">54&lt;/span> &lt;span class="n">es3&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">zenlab&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">local&lt;/span> &lt;span class="n">systemd&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]:&lt;/span> &lt;span class="n">Starting&lt;/span> &lt;span class="n">Elasticsearch&lt;/span>&lt;span class="o">...&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">es3&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Aug&lt;/span> &lt;span class="mi">27&lt;/span> &lt;span class="mi">05&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">55&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">21&lt;/span> &lt;span class="n">es3&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">zenlab&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">local&lt;/span> &lt;span class="n">systemd&lt;/span>&lt;span class="p">[&lt;/span>&lt;span class="mi">1&lt;/span>&lt;span class="p">]:&lt;/span> &lt;span class="n">Started&lt;/span> &lt;span class="n">Elasticsearch&lt;/span>&lt;span class="o">.&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">es3&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Provisioning&lt;/span> &lt;span class="n">script&lt;/span> &lt;span class="n">works&lt;/span> &lt;span class="n">good&lt;/span>&lt;span class="o">!&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> &lt;span class="n">es3&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">Please&lt;/span> &lt;span class="n">access&lt;/span> &lt;span class="n">Elasticsearch&lt;/span> &lt;span class="n">https&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="o">//&lt;/span>&lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">50.13&lt;/span>&lt;span class="p">:&lt;/span>&lt;span class="mi">9200&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>最后的系统登录验证命令：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt">1
&lt;/span>&lt;span class="lnt">2
&lt;/span>&lt;span class="lnt">3
&lt;/span>&lt;span class="lnt">4
&lt;/span>&lt;span class="lnt">5
&lt;/span>&lt;span class="lnt">6
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="err">➜&lt;/span> &lt;span class="n">elasticstack&lt;/span> &lt;span class="n">git&lt;/span>&lt;span class="p">:(&lt;/span>&lt;span class="n">master&lt;/span>&lt;span class="p">)&lt;/span> &lt;span class="err">✗&lt;/span> &lt;span class="n">curl&lt;/span> &lt;span class="o">--&lt;/span>&lt;span class="n">cacert&lt;/span> &lt;span class="n">certs&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">ca&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">ca&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">crt&lt;/span> &lt;span class="o">-&lt;/span>&lt;span class="n">u&lt;/span> &lt;span class="n">elastic&lt;/span> &lt;span class="s1">&amp;#39;https://es1.zenlab.local:9200/_cat/nodes?v&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">Enter&lt;/span> &lt;span class="n">host&lt;/span> &lt;span class="n">password&lt;/span> &lt;span class="k">for&lt;/span> &lt;span class="n">user&lt;/span> &lt;span class="s1">&amp;#39;elastic&amp;#39;&lt;/span>&lt;span class="p">:&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">ip&lt;/span> &lt;span class="n">heap&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">percent&lt;/span> &lt;span class="n">ram&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">percent&lt;/span> &lt;span class="n">cpu&lt;/span> &lt;span class="n">load_1m&lt;/span> &lt;span class="n">load_5m&lt;/span> &lt;span class="n">load_15m&lt;/span> &lt;span class="n">node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">role&lt;/span> &lt;span class="n">master&lt;/span> &lt;span class="n">name&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">50.13&lt;/span> &lt;span class="mi">26&lt;/span> &lt;span class="mi">95&lt;/span> &lt;span class="mi">8&lt;/span> &lt;span class="mf">0.03&lt;/span> &lt;span class="mf">0.31&lt;/span> &lt;span class="mf">0.18&lt;/span> &lt;span class="n">dilmrt&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">es3&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">50.12&lt;/span> &lt;span class="mi">33&lt;/span> &lt;span class="mi">95&lt;/span> &lt;span class="mi">0&lt;/span> &lt;span class="mf">0.01&lt;/span> &lt;span class="mf">0.14&lt;/span> &lt;span class="mf">0.09&lt;/span> &lt;span class="n">dilmrt&lt;/span> &lt;span class="o">-&lt;/span> &lt;span class="n">es2&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="mf">192.168&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="mf">50.11&lt;/span> &lt;span class="mi">36&lt;/span> &lt;span class="mi">93&lt;/span> &lt;span class="mi">1&lt;/span> &lt;span class="mf">0.06&lt;/span> &lt;span class="mf">0.16&lt;/span> &lt;span class="mf">0.12&lt;/span> &lt;span class="n">dilmrt&lt;/span> &lt;span class="o">*&lt;/span> &lt;span class="n">es1&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>以上命令需要输入 elastic 用户的密码，es1 节点初始化了所有 Elasticsearch 内置用户的密码，需要复制 console 中的那一段密码信息备用。&lt;/p>
&lt;p>创建以上所有数字证书和秘钥文件的种子文件是 certs/instance.yml ：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-fallback" data-lang="fallback">&lt;span class="line">&lt;span class="cl"># instance.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">instances:
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &amp;#39;es1&amp;#39;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip: [&amp;#39;192.168.50.11&amp;#39;]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dns: [ &amp;#39;es1.zenlab.local&amp;#39; ]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &amp;#34;es2&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip: [&amp;#39;192.168.50.12&amp;#39;]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dns: [ &amp;#39;es2.zenlab.local&amp;#39; ]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &amp;#39;es3&amp;#39;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip: [&amp;#39;192.168.50.13&amp;#39;]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dns: [ &amp;#39;es3.zenlab.local&amp;#39; ]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &amp;#39;es4&amp;#39;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip: [&amp;#39;192.168.50.14&amp;#39;]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dns: [ &amp;#39;es4.zenlab.local&amp;#39; ]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &amp;#34;es5&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip: [&amp;#39;192.168.50.15&amp;#39;]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dns: [ &amp;#39;es5.zenlab.local&amp;#39; ]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &amp;#39;es6&amp;#39;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip: [&amp;#39;192.168.50.16&amp;#39;]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dns: [ &amp;#39;es6.zenlab.local&amp;#39; ]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &amp;#39;es7&amp;#39;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip: [&amp;#39;192.168.50.17&amp;#39;]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dns: [ &amp;#39;es1.zenlab.local&amp;#39; ]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &amp;#34;es8&amp;#34;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip: [&amp;#39;192.168.50.18&amp;#39;]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dns: [ &amp;#39;es2.zenlab.local&amp;#39; ]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &amp;#39;es9&amp;#39;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip: [&amp;#39;192.168.50.19&amp;#39;]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dns: [ &amp;#39;es3.zenlab.local&amp;#39; ]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> - name: &amp;#39;lk&amp;#39;
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> ip: [&amp;#39;192.168.50.20&amp;#39;]
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl"> dns: [ &amp;#39;lk.zenlab.local&amp;#39; ]
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>这里一次性生产了所有我这个本地测试环境里可能用到的数字证书文件。&lt;/p>
&lt;h2 id="elasticsearch-安装脚本">Elasticsearch 安装脚本
&lt;/h2>&lt;p>下面是第一个 Elasticsearch 节点的安装脚本和注释，pre-install-es1.sh ：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;span class="lnt">49
&lt;/span>&lt;span class="lnt">50
&lt;/span>&lt;span class="lnt">51
&lt;/span>&lt;span class="lnt">52
&lt;/span>&lt;span class="lnt">53
&lt;/span>&lt;span class="lnt">54
&lt;/span>&lt;span class="lnt">55
&lt;/span>&lt;span class="lnt">56
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-bash" data-lang="bash">&lt;span class="line">&lt;span class="cl">&lt;span class="cp">#!/bin/bash
&lt;/span>&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="cp">&lt;/span>&lt;span class="c1"># author: Martin Liu&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># url:martinliu.cn&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#指定安装的版本&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nv">elastic_version&lt;/span>&lt;span class="o">=&lt;/span>&lt;span class="s1">&amp;#39;7.9.0&amp;#39;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#开始安装流程&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> &lt;span class="s2">&amp;#34;Provisioning a Elasticsearch &amp;#34;&lt;/span>&lt;span class="nv">$elastic_version&lt;/span>&lt;span class="s2">&amp;#34; Server...&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo date &amp;gt; /etc/vagrant_provisioned_at
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#配置 ES 需要的操作系统参数&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo swapoff -a
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo sysctl -w vm.max_map_count&lt;span class="o">=&lt;/span>&lt;span class="m">262144&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo sysctl -p
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo sh -c &lt;span class="s2">&amp;#34;echo &amp;#39;elasticsearch - nofile 65535&amp;#39; &amp;gt;&amp;gt; /etc/security/limits.conf&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#设置个性化 SSH 登录提示信息&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo sh -c &lt;span class="s2">&amp;#34;echo &amp;#39;**** -- -- -- -- -- -- -- -- ****&amp;#39; &amp;gt; /etc/motd&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo sh -c &lt;span class="s2">&amp;#34;echo &amp;#39;**** Welcome to Elastic Stack Labs&amp;#39; &amp;gt;&amp;gt; /etc/motd&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo sh -c &lt;span class="s2">&amp;#34;echo &amp;#39;**** -- -- -- -- -- -- -- -- ****&amp;#39; &amp;gt;&amp;gt; /etc/motd&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo sh -c &lt;span class="s2">&amp;#34;echo &amp;#39;*&amp;#39; &amp;gt;&amp;gt; /etc/motd&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#安装 ES 软件包&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo rpm -ivh /vagrant/rpm/elasticsearch-&lt;span class="nv">$elastic_version&lt;/span>-x86_64.rpm
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#创建 ES 集群内部通信加密数字证书，提前清理旧的证书文件和目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo rm -f /vagrant/certs/certs.zip
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo rm -rf /vagrant/certs/es*
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo rm -rf /vagrant/certs/ca
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo rm -rf /vagrant/certs/lk
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo /usr/share/elasticsearch/bin/elasticsearch-certutil cert -in /vagrant/certs/instance.yml -pem -out /vagrant/certs/certs.zip -s
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#解压缩所有证书备用&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo /usr/bin/unzip /vagrant/certs/certs.zip -d /vagrant/certs/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#部署节点需要的秘钥&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo cp /vagrant/certs/ca/ca.crt /etc/elasticsearch/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo cp /vagrant/certs/es1/* /etc/elasticsearch/
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#更新 ES 默认的配置文件&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo cp /vagrant/es1.yml /etc/elasticsearch/elasticsearch.yml
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#配置和启动 ES 系统服务&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl daemon-reload
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl &lt;span class="nb">enable&lt;/span> elasticsearch.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl start elasticsearch.service
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo systemctl status elasticsearch
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#初始化 ES 服务器内建用户的密码，这些密码需要在控制台上复制保存备用&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">sudo /usr/share/elasticsearch/bin/elasticsearch-setup-passwords auto -b
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#成功顺利的完成了安装&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> Provisioning script works good!
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="nb">echo&lt;/span> Please access Elasticsearch https://192.168.50.11:9200
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>说明：你也可以参考以上脚本手工执行，如果是非 Vagrant 环境，请注意替换各个命令中相关文件的路径。第二个和第三个节点的安装脚本稍有不同，详情见代码库。&lt;/p>
&lt;h2 id="elasticsearch-配置文件">Elasticsearch 配置文件
&lt;/h2>&lt;p>下面是第一个 Elasticsearch 节点的参考配置文件， es1.yml ：&lt;/p>
&lt;div class="highlight">&lt;div class="chroma">
&lt;table class="lntable">&lt;tr>&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code>&lt;span class="lnt"> 1
&lt;/span>&lt;span class="lnt"> 2
&lt;/span>&lt;span class="lnt"> 3
&lt;/span>&lt;span class="lnt"> 4
&lt;/span>&lt;span class="lnt"> 5
&lt;/span>&lt;span class="lnt"> 6
&lt;/span>&lt;span class="lnt"> 7
&lt;/span>&lt;span class="lnt"> 8
&lt;/span>&lt;span class="lnt"> 9
&lt;/span>&lt;span class="lnt">10
&lt;/span>&lt;span class="lnt">11
&lt;/span>&lt;span class="lnt">12
&lt;/span>&lt;span class="lnt">13
&lt;/span>&lt;span class="lnt">14
&lt;/span>&lt;span class="lnt">15
&lt;/span>&lt;span class="lnt">16
&lt;/span>&lt;span class="lnt">17
&lt;/span>&lt;span class="lnt">18
&lt;/span>&lt;span class="lnt">19
&lt;/span>&lt;span class="lnt">20
&lt;/span>&lt;span class="lnt">21
&lt;/span>&lt;span class="lnt">22
&lt;/span>&lt;span class="lnt">23
&lt;/span>&lt;span class="lnt">24
&lt;/span>&lt;span class="lnt">25
&lt;/span>&lt;span class="lnt">26
&lt;/span>&lt;span class="lnt">27
&lt;/span>&lt;span class="lnt">28
&lt;/span>&lt;span class="lnt">29
&lt;/span>&lt;span class="lnt">30
&lt;/span>&lt;span class="lnt">31
&lt;/span>&lt;span class="lnt">32
&lt;/span>&lt;span class="lnt">33
&lt;/span>&lt;span class="lnt">34
&lt;/span>&lt;span class="lnt">35
&lt;/span>&lt;span class="lnt">36
&lt;/span>&lt;span class="lnt">37
&lt;/span>&lt;span class="lnt">38
&lt;/span>&lt;span class="lnt">39
&lt;/span>&lt;span class="lnt">40
&lt;/span>&lt;span class="lnt">41
&lt;/span>&lt;span class="lnt">42
&lt;/span>&lt;span class="lnt">43
&lt;/span>&lt;span class="lnt">44
&lt;/span>&lt;span class="lnt">45
&lt;/span>&lt;span class="lnt">46
&lt;/span>&lt;span class="lnt">47
&lt;/span>&lt;span class="lnt">48
&lt;/span>&lt;/code>&lt;/pre>&lt;/td>
&lt;td class="lntd">
&lt;pre tabindex="0" class="chroma">&lt;code class="language-gdscript3" data-lang="gdscript3">&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ---------------------------------- Cluster -----------------------------------&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#设定集群名称&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cluster&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">elk4devops&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ------------------------------------ Node ------------------------------------&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#设定节点名称，此处使用的是 hostname&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">es1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ----------------------------------- Paths ------------------------------------&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#设定 es 服务器数据目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">data&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">lib&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">elasticsearch&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#设定 es 服务器日志目录&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">path&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">logs&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">/&lt;/span>&lt;span class="k">var&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="nb">log&lt;/span>&lt;span class="o">/&lt;/span>&lt;span class="n">elasticsearch&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ---------------------------------- Network -----------------------------------&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#设定此节点加入网络的名称，这里使用的是 FQDN&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">network&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">host&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">es1&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">zenlab&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">local&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># --------------------------------- Discovery ----------------------------------&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#设定初始的 master 节点为 es1&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">cluster&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">initial_master_nodes&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;es1&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">discovery&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">seed_hosts&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="p">[&lt;/span>&lt;span class="s2">&amp;#34;es1.zenlab.local&amp;#34;&lt;/span>&lt;span class="p">]&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ------------------------------- TLS and Cert ---------------------------------&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#启用用户名和密码认证&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">xpack&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">security&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">enabled&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="bp">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#启用 ES 集群内加密传输&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">xpack&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">security&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">transport&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ssl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">enabled&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="bp">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">xpack&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">security&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">transport&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ssl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">certificate_authorities&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">ca&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">crt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">xpack&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">security&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">transport&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ssl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">xpack&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">security&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">transport&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ssl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">certificate&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">crt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#启用 ES 集群客户端访问加密&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">xpack&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">security&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">http&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ssl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">enabled&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="bp">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">xpack&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">security&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">http&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ssl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">certificate_authorities&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="n">ca&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">crt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">xpack&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">security&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">http&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ssl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">key&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">key&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">xpack&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">security&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">http&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">ssl&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">certificate&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="o">$&lt;/span>&lt;span class="p">{&lt;/span>&lt;span class="n">node&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">name&lt;/span>&lt;span class="p">}&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">crt&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># For Elastic Agent&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">xpack&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">security&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">authc&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">api_key&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">enabled&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="bp">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#启用监控数据收集&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">xpack&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">monitoring&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">collection&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">enabled&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="bp">true&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1"># ------------------------------- App Search ---------------------------------&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="c1">#提前为 App Search 做好准备&lt;/span>
&lt;/span>&lt;/span>&lt;span class="line">&lt;span class="cl">&lt;span class="n">action&lt;/span>&lt;span class="o">.&lt;/span>&lt;span class="n">auto_create_index&lt;/span>&lt;span class="p">:&lt;/span> &lt;span class="s2">&amp;#34;.app-search-*-logs-*,-.app-search-*,+*&amp;#34;&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/td>&lt;/tr>&lt;/table>
&lt;/div>
&lt;/div>&lt;p>说明：第二个和第三个节点的配置文件稍有不同，详情见代码库。&lt;/p>
&lt;h2 id="总结">总结
&lt;/h2>&lt;p>在三节点集群的搭建过程中，最好建议启用各种安全和加密选项，用配置安装脚本最小化工作量；这样一步到位的安全性，可以为后续增加其他 Elastic Stack 的产品组件打下良好的基础，ES 集群的配置尽量完善，尽量覆盖后期的其他各种潜在需求，减少未来配置变更的工作量，让后续的测试越来越轻松。&lt;/p></description></item></channel></rss>
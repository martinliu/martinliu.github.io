{{/*
  优化的图片组件 - 支持 AVIF/WebP/JPEG 三格式
  支持懒加载、响应式图片，针对 LCP 优化
*/}}

{{ $src := .src }}
{{ $alt := .alt | default "图片" }}
{{ $class := .class | default "" }}
{{ $width := .width | default 800 }}
{{ $height := .height | default 600 }}
{{ $lazy := .lazy | default true }}
{{ $priority := .priority | default false }}

{{ $image := resources.Get $src }}
{{ if $image }}
  {{ $avif := $image.Resize (printf "%dx%d avif q85" $width $height) }}
  {{ $webp := $image.Resize (printf "%dx%d webp q85" $width $height) }}
  {{ $jpeg := $image.Resize (printf "%dx%d jpeg q85" $width $height) }}
  {{ $small_avif := $image.Resize "400x300 avif q80" }}
  {{ $small_webp := $image.Resize "400x300 webp q80" }}
  {{ $small_jpeg := $image.Resize "400x300 jpeg q80" }}
  
  <picture class="responsive-image {{ $class }}">
    {{/* AVIF 格式 - 桌面 */}}
    <source 
      srcset="{{ $avif.RelPermalink }}" 
      type="image/avif"
      media="(min-width: 768px)">
    
    {{/* AVIF 格式 - 移动端 */}}
    <source 
      srcset="{{ $small_avif.RelPermalink }}" 
      type="image/avif"
      media="(max-width: 767px)">
    
    {{/* WebP 格式 - 桌面 */}}
    <source 
      srcset="{{ $webp.RelPermalink }}" 
      type="image/webp"
      media="(min-width: 768px)">
    
    {{/* WebP 格式 - 移动端 */}}
    <source 
      srcset="{{ $small_webp.RelPermalink }}" 
      type="image/webp"
      media="(max-width: 767px)">
    
    {{/* JPEG 格式 - 桌面 */}}
    <source 
      srcset="{{ $jpeg.RelPermalink }}" 
      type="image/jpeg"
      media="(min-width: 768px)">
    
    {{/* JPEG 格式 - 移动端 */}}
    <source 
      srcset="{{ $small_jpeg.RelPermalink }}" 
      type="image/jpeg"
      media="(max-width: 767px)">
    
    {{/* 默认图片 */}}
    <img 
      src="{{ $small_jpeg.RelPermalink }}"
      data-src="{{ $jpeg.RelPermalink }}"
      alt="{{ $alt }}"
      width="{{ $width }}"
      height="{{ $height }}"
      {{ if $priority }}
        fetchpriority="high"
        loading="eager"
      {{ else if $lazy }}
        loading="lazy"
      {{ end }}
      decoding="async"
      class="lazyload {{ $class }}"
      style="background-color: #f8f9fa; width: 100%; height: auto;">
  </picture>
{{ else }}
  {{/* 备用方案 */}}
  <img 
    src="{{ $src | relURL }}"
    alt="{{ $alt }}"
    width="{{ $width }}"
    height="{{ $height }}"
    {{ if $priority }}
      fetchpriority="high"
      loading="eager"
    {{ else if $lazy }}
      loading="lazy"
    {{ end }}
    decoding="async"
    class="lazyload {{ $class }}"
    style="background-color: #f8f9fa; width: 100%; height: auto;">
{{ end }}

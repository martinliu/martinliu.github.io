name: ğŸ§ª Feature Branch Preview

on:
  push:
    branches-ignore: [master]
  pull_request:
    types: [opened, synchronize, reopened]

env:
  HUGO_VERSION: "0.148.1"
  GO_VERSION: "1.22"

jobs:
  build-preview:
    runs-on: ubuntu-latest
    if: github.event_name == 'push' || (github.event_name == 'pull_request' && github.event.action != 'closed')
    
    steps:
      - name: ğŸ“¥ Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: ğŸ—ï¸ Setup Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      - name: ğŸ“¦ Cache Hugo resources
        uses: actions/cache@v4
        with:
          path: |
            resources
            ~/.cache/go-build
            ~/go/pkg/mod
          key: ${{ runner.os }}-hugo-${{ env.HUGO_VERSION }}-${{ hashFiles('**/go.sum') }}
          restore-keys: |
            ${{ runner.os }}-hugo-

      - name: ğŸ”§ Setup Hugo
        uses: peaceiris/actions-hugo@v3
        with:
          hugo-version: ${{ env.HUGO_VERSION }}
          extended: true

      - name: ğŸ—ï¸ Build site (draft mode)
        run: |
          echo "Building preview for branch: ${{ github.ref_name }}"
          hugo --buildDrafts --buildFuture --minify --gc --environment development
          
      - name: ğŸ§ª Run basic tests
        run: |
          # æ£€æŸ¥å…³é”®æ–‡ä»¶æ˜¯å¦å­˜åœ¨
          test -f public/index.html || (echo "âŒ Index file missing" && exit 1)
          test -f public/sitemap.xml || (echo "âŒ Sitemap missing" && exit 1)
          
          # æ£€æŸ¥åŸºæœ¬ç»“æ„
          find public -name "*.html" | head -5 | while read file; do
            if ! grep -q "<title>" "$file"; then
              echo "âš ï¸ Warning: $file missing title tag"
            fi
          done
          
          echo "âœ… Basic tests passed"

      - name: ğŸ“Š Preview summary
        run: |
          echo "## ğŸ§ª Feature Branch Preview" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Build Mode: Development (with drafts)" >> $GITHUB_STEP_SUMMARY
          echo "- Files Generated: $(find public -type f | wc -l)" >> $GITHUB_STEP_SUMMARY

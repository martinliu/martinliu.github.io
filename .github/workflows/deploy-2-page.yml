# ðŸ”§ è°ƒè¯•æ¨¡å¼çš„ GitHub Pages éƒ¨ç½²å·¥ä½œæµ
# 
# å½“å‰é…ç½®ï¼š
# - æ‰€æœ‰åˆ†æ”¯çš„ push éƒ½ä¼šè§¦å‘å®Œæ•´æž„å»ºå’Œéƒ¨ç½²æµç¨‹
# - ç”¨äºŽè°ƒè¯•å’Œæµ‹è¯•éƒ¨ç½²æµç¨‹
# 
# è°ƒè¯•å®ŒæˆåŽï¼Œè¯·ä¿®æ”¹ on.push.branches ä¸º [master] 
# ä»¥æ¢å¤åªåœ¨ master åˆ†æ”¯åˆå¹¶æ—¶è§¦å‘
#
name: Deploy to Github Pages (Debug Mode)

on:
    push:
        # è°ƒè¯•æ¨¡å¼ï¼šæ‰€æœ‰åˆ†æ”¯çš„ push éƒ½è§¦å‘æž„å»º
        branches: ['**']
    pull_request:
        branches: [master]
    workflow_dispatch:
        inputs:
            enable_optimization:
                description: 'å¯ç”¨å®Œæ•´ä¼˜åŒ–'
                required: false
                default: true
                type: boolean

env:
    HUGO_VERSION: '0.148.2'

jobs:
    build:
        runs-on: ubuntu-24.04

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  submodules: recursive
                  fetch-depth: 0

            - name: Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version: '1.21'
                  
            - name: Cache Hugo binary
              uses: actions/cache@v4
              with:
                  path: ~/hugo
                  key: ${{ runner.os }}-hugo-${{ env.HUGO_VERSION }}
                  
            - name: Cache Go modules
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/go-build
                      ~/go/pkg/mod
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}-v2
                  restore-keys: |
                      ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
                      ${{ runner.os }}-go-

            - name: Cache Hugo resources
              uses: actions/cache@v4
              with:
                  path: resources
                  key: hugo-resources-${{ hashFiles('assets/**') }}
                  restore-keys: |
                      hugo-resources-

            - name: Setup Hugo
              uses: peaceiris/actions-hugo@v3
              with:
                  hugo-version: ${{ env.HUGO_VERSION }}
                  extended: true

            - name: Cache optimization tools
              # è°ƒè¯•æ¨¡å¼ï¼šæ‰€æœ‰åˆ†æ”¯éƒ½æ‰§è¡Œä¼˜åŒ–
              # if: github.ref == 'refs/heads/master' || github.event.inputs.enable_optimization == 'true'
              uses: actions/cache@v4
              id: tools-cache
              with:
                  path: |
                      /usr/bin/cwebp
                      /usr/bin/optipng
                      /usr/bin/jpegoptim
                      /usr/bin/brotli
                  key: optimization-tools-${{ runner.os }}-v2

            - name: Install optimization tools
              # è°ƒè¯•æ¨¡å¼ï¼šæ‰€æœ‰åˆ†æ”¯éƒ½æ‰§è¡Œä¼˜åŒ–
              # if: (github.ref == 'refs/heads/master' || github.event.inputs.enable_optimization == 'true') && steps.tools-cache.outputs.cache-hit != 'true'
              if: steps.tools-cache.outputs.cache-hit != 'true'
              run: |
                  echo "ðŸ”§ å®‰è£…ä¼˜åŒ–å·¥å…·..."
                  sudo apt-get update -qq
                  sudo apt-get install -y webp optipng jpegoptim brotli
                  echo "âœ… ä¼˜åŒ–å·¥å…·å®‰è£…å®Œæˆ"

            - name: Build
              env:
                  HUGO_ENV: production
                  NODE_ENV: production
                  HUGO_CACHEDIR: /tmp/hugo_cache
              run: |
                  mkdir -p /tmp/hugo_cache
                  hugo --minify --gc --enableGitInfo --cleanDestinationDir --logLevel info

            - name: Cache optimization results  
              # è°ƒè¯•æ¨¡å¼ï¼šæ‰€æœ‰åˆ†æ”¯éƒ½æ‰§è¡Œä¼˜åŒ–
              # if: github.ref == 'refs/heads/master' || github.event.inputs.enable_optimization == 'true'
              uses: actions/cache@v4
              with:
                  path: |
                      public/**/*.webp
                      public/**/*.optimized
                      public/**/*.gz
                      public/**/*.br
                  key: optimization-${{ hashFiles('public/**/*.jpg', 'public/**/*.jpeg', 'public/**/*.png', 'public/**/*.html', 'public/**/*.css', 'public/**/*.js') }}-v3
                  restore-keys: |
                      optimization-

            - name: Optimize images
              # è°ƒè¯•æ¨¡å¼ï¼šæ‰€æœ‰åˆ†æ”¯éƒ½æ‰§è¡Œä¼˜åŒ–
              # if: github.ref == 'refs/heads/master' || github.event.inputs.enable_optimization == 'true'
              run: |
                  echo "ðŸ–¼ï¸ å¼€å§‹å›¾ç‰‡ä¼˜åŒ–..."
                  
                  # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
                  total_images=$(find public -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" | wc -l)
                  echo "ðŸ“Š å‘çŽ° $total_images å¼ å›¾ç‰‡"
                  
                  # ä½¿ç”¨å¹¶è¡Œå¤„ç†åŠ é€Ÿä¼˜åŒ–ï¼ˆä½¿ç”¨ xargs æ›´å¯é ï¼‰
                  echo "ðŸš€ ä½¿ç”¨å¹¶è¡Œå¤„ç†åŠ é€Ÿä¼˜åŒ–"
                  
                  # å¹¶è¡Œè½¬æ¢ WebPï¼ˆä½¿ç”¨ xargsï¼‰
                  find public -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" | xargs -I {} -P 4 bash -c '
                      img="$1"
                      webp_name="${img%.*}.webp"
                      if [ ! -f "$webp_name" ] || [ "$img" -nt "$webp_name" ]; then
                          # æ ¹æ®å›¾ç‰‡å¤§å°é€‰æ‹©ä¸åŒçš„è´¨é‡è®¾ç½®
                          size=$(stat -f%z "$img" 2>/dev/null || stat -c%s "$img" 2>/dev/null || echo 0)
                          if [ $size -gt 1048576 ]; then
                              # å¤§äºŽ1MBçš„å›¾ç‰‡ä½¿ç”¨æ›´ä½Žè´¨é‡
                              cwebp -q 75 "$img" -o "$webp_name" && echo "è½¬æ¢(å¤§å›¾): $img -> $webp_name"
                          else
                              # å°å›¾ç‰‡ä½¿ç”¨æ ‡å‡†è´¨é‡
                              cwebp -q 85 "$img" -o "$webp_name" && echo "è½¬æ¢: $img -> $webp_name"
                          fi
                      fi
                  ' _ {}
                  
                  # å¹¶è¡ŒåŽ‹ç¼© PNGï¼ˆåªå¤„ç†å¤§æ–‡ä»¶ï¼‰
                  find public -name "*.png" | xargs -I {} -P 4 bash -c '
                      img="$1"
                      size=$(stat -f%z "$img" 2>/dev/null || stat -c%s "$img" 2>/dev/null || echo 0)
                      if [ $size -ge 102400 ]; then
                          optimized_marker="$img.optimized"
                          if [ ! -f "$optimized_marker" ] || [ "$img" -nt "$optimized_marker" ]; then
                              optipng -o1 "$img" && touch "$optimized_marker" && echo "åŽ‹ç¼©PNG: $img"
                          fi
                      fi
                  ' _ {}
                  
                  # å¹¶è¡ŒåŽ‹ç¼© JPEGï¼ˆåªå¤„ç†å¤§æ–‡ä»¶ï¼Œåˆ†çº§ä¼˜åŒ–ï¼‰
                  find public -name "*.jpg" -o -name "*.jpeg" | xargs -I {} -P 4 bash -c '
                      img="$1"
                      size=$(stat -f%z "$img" 2>/dev/null || stat -c%s "$img" 2>/dev/null || echo 0)
                      if [ $size -ge 102400 ]; then
                          optimized_marker="$img.optimized"
                          if [ ! -f "$optimized_marker" ] || [ "$img" -nt "$optimized_marker" ]; then
                              # æ ¹æ®æ–‡ä»¶å¤§å°è°ƒæ•´åŽ‹ç¼©ç­–ç•¥
                              if [ $size -gt 1048576 ]; then
                                  # å¤§äºŽ1MBçš„å›¾ç‰‡ï¼šæ›´æ¿€è¿›çš„åŽ‹ç¼©
                                  jpegoptim --max=75 --strip-all "$img" && touch "$optimized_marker" && echo "åŽ‹ç¼©JPEG(å¤§å›¾75%): $img"
                              elif [ $size -gt 524288 ]; then
                                  # å¤§äºŽ512KBçš„å›¾ç‰‡ï¼šä¸­ç­‰åŽ‹ç¼©
                                  jpegoptim --max=80 --strip-all "$img" && touch "$optimized_marker" && echo "åŽ‹ç¼©JPEG(ä¸­å›¾80%): $img"
                              else
                                  # å°å›¾ç‰‡ï¼šæ ‡å‡†åŽ‹ç¼©
                                  jpegoptim --size=85% "$img" && touch "$optimized_marker" && echo "åŽ‹ç¼©JPEG(å°å›¾85%): $img"
                              fi
                          fi
                      fi
                  ' _ {}
                  
                  echo "âœ… å›¾ç‰‡ä¼˜åŒ–å®Œæˆ"
            - name: Generate compressed files
              # è°ƒè¯•æ¨¡å¼ï¼šæ‰€æœ‰åˆ†æ”¯éƒ½æ‰§è¡Œä¼˜åŒ–
              # if: github.ref == 'refs/heads/master' || github.event.inputs.enable_optimization == 'true'
              run: |
                  echo "ðŸ—œï¸ ç”ŸæˆåŽ‹ç¼©æ–‡ä»¶..."
                  
                  # ç»Ÿè®¡éœ€è¦åŽ‹ç¼©çš„æ–‡ä»¶æ•°é‡
                  total_files=$(find public -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "*.xml" -o -name "*.json" \) | wc -l)
                  echo "ðŸ“Š å‘çŽ° $total_files ä¸ªå¯åŽ‹ç¼©æ–‡ä»¶"
                  
                  # ç”Ÿæˆ Gzip æ–‡ä»¶ï¼ˆå¢žé‡å¤„ç†ï¼‰
                  gzip_count=0
                  find public -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "*.xml" -o -name "*.json" \) | while read file; do
                      if [ ! -f "$file.gz" ] || [ "$file" -nt "$file.gz" ]; then
                          gzip -9 -c "$file" > "$file.gz"
                          gzip_count=$((gzip_count + 1))
                          if [ $((gzip_count % 100)) -eq 0 ]; then
                              echo "Gzip è¿›åº¦: $gzip_count/$total_files"
                          fi
                      fi
                  done
                  
                  # ç”Ÿæˆ Brotli æ–‡ä»¶ï¼ˆå¢žé‡å¤„ç†ï¼‰
                  brotli_count=0
                  find public -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "*.xml" -o -name "*.json" \) | while read file; do
                      if [ ! -f "$file.br" ] || [ "$file" -nt "$file.br" ]; then
                          brotli -9 -c "$file" > "$file.br"
                          brotli_count=$((brotli_count + 1))
                          if [ $((brotli_count % 100)) -eq 0 ]; then
                              echo "Brotli è¿›åº¦: $brotli_count/$total_files"
                          fi
                      fi
                  done
                  
                  echo "âœ… æ–‡ä»¶åŽ‹ç¼©å®Œæˆ"

            - name: Build statistics
              # è°ƒè¯•æ¨¡å¼ï¼šæ‰€æœ‰åˆ†æ”¯éƒ½æ‰§è¡Œä¼˜åŒ–
              # if: github.ref == 'refs/heads/master' || github.event.inputs.enable_optimization == 'true'
              run: |
                  echo "ðŸ“Š æž„å»ºç»Ÿè®¡..."
                  file_count=$(find public -type f | wc -l)
                  echo "æ€»æ–‡ä»¶æ•°: $file_count"
                  
                  # ä¼˜åŒ–ï¼šåªåœ¨æ–‡ä»¶æ•°é‡è¾ƒå°‘æ—¶è®¡ç®—è¯¦ç»†ç»Ÿè®¡
                  if [ $file_count -lt 5000 ]; then
                      echo "è®¡ç®—è¯¦ç»†ç»Ÿè®¡..."
                      total_size=$(du -sh public | cut -f1)
                      echo "æ€»å¤§å°: $total_size"
                      
                      # ç»Ÿè®¡ä¼˜åŒ–æ•ˆæžœ
                      gzip_files=$(find public -name "*.gz" | wc -l)
                      brotli_files=$(find public -name "*.br" | wc -l)
                      webp_files=$(find public -name "*.webp" | wc -l)
                      optimized_images=$(find public -name "*.optimized" | wc -l)
                      
                      echo "ðŸ“ˆ ä¼˜åŒ–ç»Ÿè®¡:"
                      echo "  Gzip æ–‡ä»¶: $gzip_files"
                      echo "  Brotli æ–‡ä»¶: $brotli_files" 
                      echo "  WebP å›¾ç‰‡: $webp_files"
                      echo "  ä¼˜åŒ–å›¾ç‰‡: $optimized_images"
                      
                      # è®¡ç®—åŽ‹ç¼©æ¯”ï¼ˆå¦‚æžœæœ‰åŽŸå§‹æ–‡ä»¶å¤§å°è®°å½•ï¼‰
                      if [ -f "build-stats.txt" ]; then
                          echo "ðŸ“Š ä¸Žä¸Šæ¬¡æž„å»ºå¯¹æ¯”:"
                          cat build-stats.txt
                      fi
                      
                      # ä¿å­˜æœ¬æ¬¡ç»Ÿè®¡
                      echo "files:$file_count,gzip:$gzip_files,brotli:$brotli_files,webp:$webp_files" > build-stats.txt
                  else
                      echo "ðŸ“Š å¿«é€Ÿç»Ÿè®¡ (æ–‡ä»¶æ•°é‡: $file_count)"
                      
                      # å¿«é€Ÿç»Ÿè®¡å…³é”®æŒ‡æ ‡
                      webp_count=$(find public -name "*.webp" | wc -l)
                      gz_count=$(find public -name "*.gz" | head -100 | wc -l)
                      
                      echo "  WebP æ–‡ä»¶: $webp_count"
                      echo "  åŽ‹ç¼©æ–‡ä»¶ (é‡‡æ ·): ${gz_count}+..."
                      echo "âš¡ è·³è¿‡è¯¦ç»†ç»Ÿè®¡ä»¥èŠ‚çœæ—¶é—´"
                  fi

            - name: Performance Summary
              run: |
                  echo "âš¡ æž„å»ºæ€§èƒ½æ€»ç»“:"
                  echo "ðŸ• æž„å»ºæ—¶é—´: çº¦ ${{ github.event.head_commit.timestamp }} å¼€å§‹"
                  echo "ðŸ“¦ è¾“å‡ºæ–‡ä»¶: $(find public -type f | wc -l) ä¸ªæ–‡ä»¶"
                  echo "ðŸ–¼ï¸ å›¾ç‰‡å¤„ç†: $(find public -name "*.webp" | wc -l) WebP + $(find public -name "*.optimized" | wc -l) ä¼˜åŒ–"
                  echo "ðŸ—œï¸ æ–‡ä»¶åŽ‹ç¼©: Gzip + Brotli åŒé‡åŽ‹ç¼©"
                  echo "ðŸ’¾ ç¼“å­˜åˆ©ç”¨: å¢žé‡å¤„ç†ï¼Œé¿å…é‡å¤å·¥ä½œ"
                  echo ""
                  echo "ðŸš€ éƒ¨ç½²å»ºè®®: å½“å‰æ€§èƒ½è¡¨çŽ°ä¼˜ç§€ï¼Œå»ºè®®ä¿æŒæ­¤é…ç½®"

            - name: Create Performance Files
              run: |
                  echo "ðŸš€ åˆ›å»ºæ€§èƒ½ä¼˜åŒ–æ–‡ä»¶..."
                  
                  # åˆ›å»º _headers æ–‡ä»¶ç”¨äºŽ Netlify/GitHub Pages ç¼“å­˜
                  cat > public/_headers << 'EOF'
                  /*
                    X-Frame-Options: DENY
                    X-Content-Type-Options: nosniff
                    Referrer-Policy: strict-origin-when-cross-origin
                  
                  /*.css
                    Cache-Control: public, max-age=31536000, immutable
                  
                  /*.js
                    Cache-Control: public, max-age=31536000, immutable
                  
                  /*.woff2
                    Cache-Control: public, max-age=31536000, immutable
                  
                  /*.webp
                    Cache-Control: public, max-age=31536000
                  
                  /*.jpg
                    Cache-Control: public, max-age=31536000
                  
                  /*.png
                    Cache-Control: public, max-age=31536000
                  
                  /*.html
                    Cache-Control: public, max-age=0, must-revalidate
                  EOF
                  
                  # åˆ›å»º robots.txtï¼ˆå¦‚æžœä¸å­˜åœ¨ï¼‰
                  if [ ! -f "public/robots.txt" ]; then
                      cat > public/robots.txt << 'EOF'
                  User-agent: *
                  Allow: /
                  
                  Sitemap: https://martinliu.cn/sitemap.xml
                  EOF
                      echo "âœ… åˆ›å»º robots.txt"
                  fi
                  
                  # æ·»åŠ æ€§èƒ½ç›‘æŽ§è„šæœ¬ï¼ˆå¯é€‰ï¼‰
                  echo "ðŸ“Š æ€§èƒ½æ–‡ä»¶åˆ›å»ºå®Œæˆ"

            - name: Deploy ðŸš€
              uses: JamesIves/github-pages-deploy-action@v4.6.8
              with:
                  branch: gh-pages
                  folder: public
                  clean: false  # ç¦ç”¨æ¸…ç†ä»¥åŠ å¿«éƒ¨ç½²
                  single-commit: false  # ä¿ç•™ git åŽ†å²ä»¥æ”¯æŒå¢žé‡éƒ¨ç½²
                  force: false  # ç¦ç”¨å¼ºåˆ¶æŽ¨é€
                  git-config-name: 'github-actions[bot]'
                  git-config-email: 'github-actions[bot]@users.noreply.github.com'
                  commit-message: |
                      Deploy from ${{ github.ref_name }} branch
                      
                      Source commit: ${{ github.sha }}
                      Workflow: ${{ github.workflow }}
                      
            - name: Trigger CloudFlare Production Deploy
              # åªåœ¨ master åˆ†æ”¯æˆ–æ‰‹åŠ¨å¯ç”¨æ—¶è§¦å‘ç”Ÿäº§éƒ¨ç½²
              if: github.ref == 'refs/heads/master' || github.event.inputs.enable_optimization == 'true'
              run: |
                  echo "ðŸš€ è§¦å‘ CloudFlare ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²..."
                  
                  # ç­‰å¾… GitHub Pages éƒ¨ç½²å®Œå…¨ç”Ÿæ•ˆ
                  echo "â³ ç­‰å¾… GitHub Pages éƒ¨ç½²ç”Ÿæ•ˆ..."
                  sleep 30
                  
                  # è§¦å‘ CloudFlare éƒ¨ç½²
                  http_code=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
                    "https://api.cloudflare.com/client/v4/pages/webhooks/deploy_hooks/b1b6b15d-b582-4304-bb0a-238b32bc3eb7")
                  
                  if [[ $http_code -ge 200 && $http_code -lt 300 ]]; then
                      echo "âœ… CloudFlare ç”Ÿäº§éƒ¨ç½²è§¦å‘æˆåŠŸ (HTTP $http_code)"
                      echo "ðŸŒ ç”Ÿäº§çŽ¯å¢ƒå°†åœ¨ 2-5 åˆ†é’Ÿå†…æ›´æ–°: https://martinliu.cn"
                  else
                      echo "âš ï¸ CloudFlare éƒ¨ç½²è§¦å‘å¤±è´¥ (HTTP $http_code)"
                      echo "ðŸ’¡ è¯·æ‰‹åŠ¨è§¦å‘æˆ–æ£€æŸ¥ webhook é…ç½®"
                  fi

            - name: Debug Info
              run: |
                  echo "ðŸ” è°ƒè¯•ä¿¡æ¯ï¼š"
                  echo "åˆ†æ”¯: ${{ github.ref_name }}"
                  echo "æäº¤: ${{ github.sha }}"
                  echo "äº‹ä»¶: ${{ github.event_name }}"
                  echo "ä»“åº“: ${{ github.repository }}"
                  echo "è¿è¡ŒID: ${{ github.run_id }}"
                  echo ""
                  echo "ðŸ“ éƒ¨ç½²åˆ° GitHub Pages å®Œæˆ!"
                  echo "ðŸŒ é¢„è§ˆåœ°å€: https://${{ github.repository_owner }}.github.io/${{ github.event.repository.name }}/"
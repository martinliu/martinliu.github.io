name: Deploy to Github Pages

on:
    push:
        branches: [master]
    pull_request:
        branches: [master]
    workflow_dispatch:
        inputs:
            enable_optimization:
                description: 'å¯ç”¨å®Œæ•´ä¼˜åŒ–'
                required: false
                default: 'true'
                type: boolean

env:
    HUGO_VERSION: '0.148.2'

jobs:
    build:
        runs-on: ubuntu-24.04

        steps:
            - name: Checkout
              uses: actions/checkout@v4
              with:
                  submodules: recursive
                  fetch-depth: 0

            - name: Setup Go
              uses: actions/setup-go@v5
              with:
                  go-version: '1.21'
                  
            - name: Cache Hugo binary
              uses: actions/cache@v4
              with:
                  path: ~/hugo
                  key: ${{ runner.os }}-hugo-${{ env.HUGO_VERSION }}
                  
            - name: Cache Go modules
              uses: actions/cache@v4
              with:
                  path: |
                      ~/.cache/go-build
                      ~/go/pkg/mod
                  key: ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}-v2
                  restore-keys: |
                      ${{ runner.os }}-go-${{ hashFiles('**/go.sum') }}
                      ${{ runner.os }}-go-

            - name: Cache Hugo resources
              uses: actions/cache@v4
              with:
                  path: resources
                  key: hugo-resources-${{ hashFiles('assets/**') }}
                  restore-keys: |
                      hugo-resources-

            - name: Setup Hugo
              uses: peaceiris/actions-hugo@v3
              with:
                  hugo-version: ${{ env.HUGO_VERSION }}
                  extended: true

            - name: Cache optimization tools
              if: github.ref == 'refs/heads/master' || github.event.inputs.enable_optimization == 'true'
              uses: actions/cache@v4
              id: tools-cache
              with:
                  path: |
                      /usr/bin/cwebp
                      /usr/bin/optipng
                      /usr/bin/jpegoptim
                      /usr/bin/brotli
                  key: optimization-tools-${{ runner.os }}-v2

            - name: Install optimization tools
              if: (github.ref == 'refs/heads/master' || github.event.inputs.enable_optimization == 'true') && steps.tools-cache.outputs.cache-hit != 'true'
              run: |
                  echo "ğŸ”§ å®‰è£…ä¼˜åŒ–å·¥å…·..."
                  sudo apt-get update -qq
                  sudo apt-get install -y webp optipng jpegoptim brotli
                  echo "âœ… ä¼˜åŒ–å·¥å…·å®‰è£…å®Œæˆ"

            - name: Build
              env:
                  HUGO_ENV: production
                  NODE_ENV: production
                  HUGO_CACHEDIR: /tmp/hugo_cache
              run: |
                  mkdir -p /tmp/hugo_cache
                  hugo --minify --gc --enableGitInfo --cleanDestinationDir --logLevel info

            - name: Cache optimization results  
              if: github.ref == 'refs/heads/master' || github.event.inputs.enable_optimization == 'true'
              uses: actions/cache@v4
              with:
                  path: |
                      public/**/*.webp
                      public/**/*.optimized
                      public/**/*.gz
                      public/**/*.br
                  key: optimization-${{ hashFiles('public/**/*.jpg', 'public/**/*.jpeg', 'public/**/*.png', 'public/**/*.html', 'public/**/*.css', 'public/**/*.js') }}-v3
                  restore-keys: |
                      optimization-

            - name: Optimize images
              if: github.ref == 'refs/heads/master' || github.event.inputs.enable_optimization == 'true'
              run: |
                  echo "ğŸ–¼ï¸ å¼€å§‹å›¾ç‰‡ä¼˜åŒ–..."
                  
                  # ç»Ÿè®¡æ–‡ä»¶æ•°é‡
                  total_images=$(find public -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" | wc -l)
                  echo "ğŸ“Š å‘ç° $total_images å¼ å›¾ç‰‡"
                  
                  # ä½¿ç”¨å¹¶è¡Œå¤„ç†åŠ é€Ÿä¼˜åŒ–ï¼ˆä½¿ç”¨ xargs æ›´å¯é ï¼‰
                  echo "ğŸš€ ä½¿ç”¨å¹¶è¡Œå¤„ç†åŠ é€Ÿä¼˜åŒ–"
                  
                  # å¹¶è¡Œè½¬æ¢ WebPï¼ˆä½¿ç”¨ xargsï¼‰
                  find public -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" | xargs -I {} -P 4 bash -c '
                      img="$1"
                      webp_name="${img%.*}.webp"
                      if [ ! -f "$webp_name" ] || [ "$img" -nt "$webp_name" ]; then
                          cwebp -q 85 "$img" -o "$webp_name" && echo "è½¬æ¢: $img -> $webp_name"
                      fi
                  ' _ {}
                  
                  # å¹¶è¡Œå‹ç¼© PNGï¼ˆåªå¤„ç†å¤§æ–‡ä»¶ï¼‰
                  find public -name "*.png" | xargs -I {} -P 4 bash -c '
                      img="$1"
                      size=$(stat -f%z "$img" 2>/dev/null || stat -c%s "$img" 2>/dev/null || echo 0)
                      if [ $size -ge 102400 ]; then
                          optimized_marker="$img.optimized"
                          if [ ! -f "$optimized_marker" ] || [ "$img" -nt "$optimized_marker" ]; then
                              optipng -o1 "$img" && touch "$optimized_marker" && echo "å‹ç¼©PNG: $img"
                          fi
                      fi
                  ' _ {}
                  
                  # å¹¶è¡Œå‹ç¼© JPEGï¼ˆåªå¤„ç†å¤§æ–‡ä»¶ï¼‰
                  find public -name "*.jpg" -o -name "*.jpeg" | xargs -I {} -P 4 bash -c '
                      img="$1"
                      size=$(stat -f%z "$img" 2>/dev/null || stat -c%s "$img" 2>/dev/null || echo 0)
                      if [ $size -ge 102400 ]; then
                          optimized_marker="$img.optimized"
                          if [ ! -f "$optimized_marker" ] || [ "$img" -nt "$optimized_marker" ]; then
                              jpegoptim --size=85% "$img" && touch "$optimized_marker" && echo "å‹ç¼©JPEG: $img"
                          fi
                      fi
                  ' _ {}
                  else
                      echo "âš ï¸ GNU parallel ä¸å¯ç”¨ï¼Œä½¿ç”¨ä¸²è¡Œå¤„ç†"
                      
                      # è½¬æ¢ä¸º WebP æ ¼å¼ï¼ˆå¢é‡å¤„ç†ï¼‰
                      webp_count=0
                      find public -name "*.jpg" -o -name "*.jpeg" -o -name "*.png" | while read img; do
                          webp_name="${img%.*}.webp"
                          if [ ! -f "$webp_name" ] || [ "$img" -nt "$webp_name" ]; then
                              cwebp -q 85 "$img" -o "$webp_name"
                              webp_count=$((webp_count + 1))
                              echo "è½¬æ¢ ($webp_count): $img -> $webp_name"
                          fi
                      done
                      
                      # å‹ç¼© PNGï¼ˆå¢é‡å¤„ç†ï¼Œä½¿ç”¨æ›´å¿«çš„å‹ç¼©çº§åˆ«ï¼‰
                      png_count=0
                      find public -name "*.png" | while read img; do
                          # è·³è¿‡å·²ç»å¾ˆå°çš„æ–‡ä»¶ï¼ˆå°äº100KBï¼‰
                          if [ $(stat -f%z "$img" 2>/dev/null || stat -c%s "$img" 2>/dev/null || echo 0) -lt 102400 ]; then
                              continue
                          fi
                          
                          # åˆ›å»ºæ ‡è®°æ–‡ä»¶æ¥è·Ÿè¸ªä¼˜åŒ–çŠ¶æ€
                          optimized_marker="${img}.optimized"
                          if [ ! -f "$optimized_marker" ] || [ "$img" -nt "$optimized_marker" ]; then
                              png_count=$((png_count + 1))
                              echo "å‹ç¼©PNG ($png_count): $img"
                              # ä½¿ç”¨æ›´å¿«çš„å‹ç¼©çº§åˆ« -o1 è€Œä¸æ˜¯ -o2
                              optipng -o1 "$img" && touch "$optimized_marker"
                          fi
                      done
                      
                      # å‹ç¼© JPEGï¼ˆå¢é‡å¤„ç†ï¼Œè·³è¿‡å°æ–‡ä»¶ï¼‰
                      jpeg_count=0
                      find public -name "*.jpg" -o -name "*.jpeg" | while read img; do
                          # è·³è¿‡å·²ç»å¾ˆå°çš„æ–‡ä»¶ï¼ˆå°äº100KBï¼‰
                          if [ $(stat -f%z "$img" 2>/dev/null || stat -c%s "$img" 2>/dev/null || echo 0) -lt 102400 ]; then
                              continue
                          fi
                          
                          # åˆ›å»ºæ ‡è®°æ–‡ä»¶æ¥è·Ÿè¸ªä¼˜åŒ–çŠ¶æ€
                          optimized_marker="${img}.optimized"
                          if [ ! -f "$optimized_marker" ] || [ "$img" -nt "$optimized_marker" ]; then
                              jpeg_count=$((jpeg_count + 1))
                              echo "å‹ç¼©JPEG ($jpeg_count): $img"
                              jpegoptim --size=85% "$img" && touch "$optimized_marker"
                          fi
                      done
                  fi
                  
                  echo "âœ… å›¾ç‰‡ä¼˜åŒ–å®Œæˆ"

            - name: Generate compressed files
              if: github.ref == 'refs/heads/master' || github.event.inputs.enable_optimization == 'true'
              run: |
                  echo "ğŸ—œï¸ ç”Ÿæˆå‹ç¼©æ–‡ä»¶..."
                  
                  # ç»Ÿè®¡éœ€è¦å‹ç¼©çš„æ–‡ä»¶æ•°é‡
                  total_files=$(find public -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "*.xml" -o -name "*.json" \) | wc -l)
                  echo "ğŸ“Š å‘ç° $total_files ä¸ªå¯å‹ç¼©æ–‡ä»¶"
                  
                  # ç”Ÿæˆ Gzip æ–‡ä»¶ï¼ˆå¢é‡å¤„ç†ï¼‰
                  gzip_count=0
                  find public -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "*.xml" -o -name "*.json" \) | while read file; do
                      if [ ! -f "$file.gz" ] || [ "$file" -nt "$file.gz" ]; then
                          gzip -9 -c "$file" > "$file.gz"
                          gzip_count=$((gzip_count + 1))
                          if [ $((gzip_count % 100)) -eq 0 ]; then
                              echo "Gzip è¿›åº¦: $gzip_count/$total_files"
                          fi
                      fi
                  done
                  
                  # ç”Ÿæˆ Brotli æ–‡ä»¶ï¼ˆå¢é‡å¤„ç†ï¼‰
                  brotli_count=0
                  find public -type f \( -name "*.html" -o -name "*.css" -o -name "*.js" -o -name "*.xml" -o -name "*.json" \) | while read file; do
                      if [ ! -f "$file.br" ] || [ "$file" -nt "$file.br" ]; then
                          brotli -9 -c "$file" > "$file.br"
                          brotli_count=$((brotli_count + 1))
                          if [ $((brotli_count % 100)) -eq 0 ]; then
                              echo "Brotli è¿›åº¦: $brotli_count/$total_files"
                          fi
                      fi
                  done
                  
                  echo "âœ… æ–‡ä»¶å‹ç¼©å®Œæˆ"

            - name: Build statistics
              if: github.ref == 'refs/heads/master' || github.event.inputs.enable_optimization == 'true'
              run: |
                  echo "ğŸ“Š æ„å»ºç»Ÿè®¡..."
                  file_count=$(find public -type f | wc -l)
                  echo "æ€»æ–‡ä»¶æ•°: $file_count"
                  
                  # åªåœ¨æ–‡ä»¶æ•°é‡è¾ƒå°‘æ—¶è®¡ç®—å¤§å°ï¼ˆé¿å…é•¿æ—¶é—´è®¡ç®—ï¼‰
                  if [ $file_count -lt 10000 ]; then
                      echo "æ€»å¤§å°: $(du -sh public | cut -f1)"
                      
                      # å¿«é€Ÿç»Ÿè®¡å‹ç¼©æ–‡ä»¶
                      gzip_files=$(find public -name "*.gz" | wc -l)
                      brotli_files=$(find public -name "*.br" | wc -l)
                      webp_files=$(find public -name "*.webp" | wc -l)
                      
                      echo "Gzip æ–‡ä»¶æ•°: $gzip_files"
                      echo "Brotli æ–‡ä»¶æ•°: $brotli_files" 
                      echo "WebP æ–‡ä»¶æ•°: $webp_files"
                  else
                      echo "æ–‡ä»¶æ•°é‡è¾ƒå¤šï¼Œè·³è¿‡è¯¦ç»†ç»Ÿè®¡ä»¥èŠ‚çœæ—¶é—´"
                  fi

            - name: Deploy ğŸš€
              uses: JamesIves/github-pages-deploy-action@v4.6.8
              with:
                  branch: gh-pages
                  folder: public
                  clean: false  # ç¦ç”¨æ¸…ç†ä»¥åŠ å¿«éƒ¨ç½²
                  single-commit: false  # ä¿ç•™ git å†å²ä»¥æ”¯æŒå¢é‡éƒ¨ç½²
                  force: false  # ç¦ç”¨å¼ºåˆ¶æ¨é€
                  git-config-name: 'github-actions[bot]'
                  git-config-email: 'github-actions[bot]@users.noreply.github.com'
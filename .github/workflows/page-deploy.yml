# è§¦å‘ CloudFlare ç”Ÿäº§ç¯å¢ƒéƒ¨ç½² 
name: CD - Push to PRD*CloudFlare

# åœ¨ GitHub Pages éƒ¨ç½²æˆåŠŸåè‡ªåŠ¨è§¦å‘
on:
  workflow_run:
    workflows: ["Deploy to Github Pages (Debug Mode)"]
    types:
      - completed
    branches:
      - master
#      - update-grafana  # è°ƒè¯•æ¨¡å¼æ”¯æŒ
  # ä¿ç•™æ‰‹åŠ¨è§¦å‘é€‰é¡¹
  workflow_dispatch:
    inputs:
      force_deploy:
        description: 'å¼ºåˆ¶éƒ¨ç½²åˆ°ç”Ÿäº§ç¯å¢ƒ'
        required: false
        default: false
        type: boolean

jobs:
  
  check-deployment-success:
    runs-on: ubuntu-latest
    # åªæœ‰å½“å‰ç½®å·¥ä½œæµæˆåŠŸå®Œæˆæ—¶æ‰æ‰§è¡Œ
    if: ${{ github.event.workflow_run.conclusion == 'success' || github.event_name == 'workflow_dispatch' }}
    
    outputs:
      should_deploy: ${{ steps.check.outputs.should_deploy }}
      source_branch: ${{ steps.check.outputs.source_branch }}
    
    steps:
      - name: æ£€æŸ¥éƒ¨ç½²æ¡ä»¶
        id: check
        run: |
          echo "ğŸ” æ£€æŸ¥éƒ¨ç½²æ¡ä»¶..."
          
          if [[ "${{ github.event_name }}" == "workflow_dispatch" ]]; then
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "source_branch=${{ github.ref_name }}" >> $GITHUB_OUTPUT
            echo "âœ… æ‰‹åŠ¨è§¦å‘éƒ¨ç½²"
          elif [[ "${{ github.event.workflow_run.conclusion }}" == "success" ]]; then
            branch="${{ github.event.workflow_run.head_branch }}"
            echo "should_deploy=true" >> $GITHUB_OUTPUT
            echo "source_branch=$branch" >> $GITHUB_OUTPUT
            echo "âœ… GitHub Pages éƒ¨ç½²æˆåŠŸï¼Œè§¦å‘ CloudFlare éƒ¨ç½²"
            echo "ğŸ“‹ æºåˆ†æ”¯: $branch"
            echo "ğŸ“‹ æºæäº¤: ${{ github.event.workflow_run.head_sha }}"
          else
            echo "should_deploy=false" >> $GITHUB_OUTPUT
            echo "âŒ å‰ç½®å·¥ä½œæµæœªæˆåŠŸï¼Œè·³è¿‡éƒ¨ç½²"
          fi

  trigger-cloudflare-deploy:
    needs: check-deployment-success
    runs-on: ubuntu-latest
    if: needs.check-deployment-success.outputs.should_deploy == 'true'

    steps:
      - name: ğŸš€ è§¦å‘ CloudFlare Pages éƒ¨ç½²
        id: deploy
        run: |
          echo "ğŸš€ å¼€å§‹è§¦å‘ CloudFlare Pages éƒ¨ç½²..."
          echo "ğŸ“‹ æºåˆ†æ”¯: ${{ needs.check-deployment-success.outputs.source_branch }}"
          echo "ğŸ“‹ è§¦å‘æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          
          # è§¦å‘ CloudFlare éƒ¨ç½²
          http_code=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            "https://api.cloudflare.com/client/v4/pages/webhooks/deploy_hooks/b1b6b15d-b582-4304-bb0a-238b32bc3eb7")
          
          if [[ $http_code -ge 200 && $http_code -lt 300 ]]; then
            echo "âœ… CloudFlare éƒ¨ç½²è§¦å‘æˆåŠŸ (HTTP $http_code)"
            echo "deploy_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ CloudFlare éƒ¨ç½²è§¦å‘å¤±è´¥ (HTTP $http_code)"
            echo "deploy_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ğŸ“Š éƒ¨ç½²æ‘˜è¦
        if: always()
        run: |
          echo "## ğŸš€ CloudFlare ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | çŠ¶æ€ |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| è§¦å‘çŠ¶æ€ | ${{ steps.deploy.outputs.deploy_status == 'success' && 'âœ… æˆåŠŸ' || 'âŒ å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| æºåˆ†æ”¯ | ${{ needs.check-deployment-success.outputs.source_branch }} |" >> $GITHUB_STEP_SUMMARY
          echo "| éƒ¨ç½²æ—¶é—´ | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| CloudFlare URL | https://martinliu.cn |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ğŸ“‹ éƒ¨ç½²è¯´æ˜" >> $GITHUB_STEP_SUMMARY
          echo "- CloudFlare Pages å°†ä» \`gh-pages\` åˆ†æ”¯è‡ªåŠ¨æ„å»ºå’Œéƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          echo "- éƒ¨ç½²å®Œæˆæ—¶é—´é€šå¸¸éœ€è¦ 2-5 åˆ†é’Ÿ" >> $GITHUB_STEP_SUMMARY
          echo "- å…¨çƒ CDN ç¼“å­˜æ›´æ–°å¯èƒ½éœ€è¦é¢å¤– 5-10 åˆ†é’Ÿ" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ”” é€šçŸ¥éƒ¨ç½²çŠ¶æ€
        if: always()
        run: |
          if [[ "${{ steps.deploy.outputs.deploy_status }}" == "success" ]]; then
            echo "ğŸ‰ CloudFlare ç”Ÿäº§ç¯å¢ƒéƒ¨ç½²å·²è§¦å‘ï¼"
            echo "ğŸŒ ç½‘ç«™å°†åœ¨å‡ åˆ†é’Ÿå†…æ›´æ–°: https://martinliu.cn"
            echo "â³ è¯·ç­‰å¾… CloudFlare å®Œæˆæ„å»ºå’Œå…¨çƒ CDN åˆ†å‘"
          else
            echo "ğŸ’¥ CloudFlare éƒ¨ç½²è§¦å‘å¤±è´¥ï¼Œè¯·æ£€æŸ¥é…ç½®æˆ–æ‰‹åŠ¨é‡è¯•"
          fi
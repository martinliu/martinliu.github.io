# è§¦å‘ CloudFlare ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½² 
name: CD - Push to PRD*CloudFlare

# å®Œå…¨æ‰‹åŠ¨è§¦å‘ï¼Œä¸ä¾èµ–å…¶ä»–å·¥ä½œæµ
on:
  workflow_dispatch:
    inputs:
      deployment_reason:
        description: 'éƒ¨ç½²åŽŸå› è¯´æ˜Ž'
        required: true
        default: 'æ‰‹åŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ'
        type: string
      confirm_production:
        description: 'ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ'
        required: true
        default: false
        type: boolean

jobs:
  
  manual-cloudflare-deploy:
    runs-on: ubuntu-latest
    # åªæœ‰ç¡®è®¤éƒ¨ç½²æ—¶æ‰æ‰§è¡Œ
    if: ${{ inputs.confirm_production == true }}
    
    steps:
      - name: ðŸ“‹ éƒ¨ç½²å‰æ£€æŸ¥
        run: |
          echo "ðŸ” éƒ¨ç½²å‰æ£€æŸ¥..."
          echo "ðŸ“ éƒ¨ç½²åŽŸå› : ${{ inputs.deployment_reason }}"
          echo "âœ… å·²ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ"
          echo "ðŸ• éƒ¨ç½²æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
          echo "ðŸ‘¤ è§¦å‘äººå‘˜: ${{ github.actor }}"
          echo "ðŸŒ¿ å½“å‰åˆ†æ”¯: ${{ github.ref_name }}"
          echo ""
          echo "âš ï¸  æ³¨æ„ï¼šå³å°†éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ CloudFlare Pages"
          echo "ðŸŒ ç”Ÿäº§åœ°å€: https://martinliu.cn"

      - name: ðŸš€ è§¦å‘ CloudFlare Pages éƒ¨ç½²
        id: deploy
        run: |
          echo "ðŸš€ å¼€å§‹è§¦å‘ CloudFlare Pages éƒ¨ç½²..."
          
          # è§¦å‘ CloudFlare éƒ¨ç½²
          http_code=$(curl -s -o /dev/null -w "%{http_code}" -X POST \
            "https://api.cloudflare.com/client/v4/pages/webhooks/deploy_hooks/b1b6b15d-b582-4304-bb0a-238b32bc3eb7")
          
          if [[ $http_code -ge 200 && $http_code -lt 300 ]]; then
            echo "âœ… CloudFlare éƒ¨ç½²è§¦å‘æˆåŠŸ (HTTP $http_code)"
            echo "deploy_status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ CloudFlare éƒ¨ç½²è§¦å‘å¤±è´¥ (HTTP $http_code)"
            echo "deploy_status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ðŸ“Š éƒ¨ç½²æ‘˜è¦
        if: always()
        run: |
          echo "## ðŸš€ CloudFlare ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| é¡¹ç›® | è¯¦æƒ… |" >> $GITHUB_STEP_SUMMARY
          echo "|------|------|" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŽ¯ éƒ¨ç½²çŠ¶æ€ | ${{ steps.deploy.outputs.deploy_status == 'success' && 'âœ… æˆåŠŸè§¦å‘' || 'âŒ è§¦å‘å¤±è´¥' }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ‘¤ æ“ä½œäººå‘˜ | ${{ github.actor }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ“ éƒ¨ç½²åŽŸå›  | ${{ inputs.deployment_reason }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸ• è§¦å‘æ—¶é—´ | $(date -u '+%Y-%m-%d %H:%M:%S UTC') |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ¿ æºåˆ†æ”¯ | ${{ github.ref_name }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ðŸŒ ç”Ÿäº§åœ°å€ | https://martinliu.cn |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### ðŸ“‹ éƒ¨ç½²è¯´æ˜Ž" >> $GITHUB_STEP_SUMMARY
          echo "- âœ¨ æ‰‹åŠ¨è§¦å‘çš„ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ“¦ CloudFlare Pages å°†ä»Ž \`gh-pages\` åˆ†æ”¯æž„å»ºéƒ¨ç½²" >> $GITHUB_STEP_SUMMARY
          echo "- â±ï¸ éƒ¨ç½²å®Œæˆé¢„è®¡éœ€è¦ 2-5 åˆ†é’Ÿ" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸŒ å…¨çƒ CDN ç¼“å­˜æ›´æ–°å¯èƒ½éœ€è¦é¢å¤– 5-10 åˆ†é’Ÿ" >> $GITHUB_STEP_SUMMARY
          echo "- ðŸ”„ å¦‚éœ€å›žæ»šï¼Œè¯·è”ç³»ç®¡ç†å‘˜æˆ–é‡æ–°éƒ¨ç½²" >> $GITHUB_STEP_SUMMARY

      - name: ðŸ”” éƒ¨ç½²ç»“æžœé€šçŸ¥
        if: always()
        run: |
          if [[ "${{ steps.deploy.outputs.deploy_status }}" == "success" ]]; then
            echo "ðŸŽ‰ CloudFlare ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²å·²æˆåŠŸè§¦å‘ï¼"
            echo ""
            echo "ðŸ“‹ éƒ¨ç½²è¯¦æƒ…:"
            echo "  ðŸ‘¤ æ“ä½œäººå‘˜: ${{ github.actor }}"
            echo "  ðŸ“ éƒ¨ç½²åŽŸå› : ${{ inputs.deployment_reason }}"
            echo "  ðŸ• è§¦å‘æ—¶é—´: $(date -u '+%Y-%m-%d %H:%M:%S UTC')"
            echo ""
            echo "â³ éƒ¨ç½²è¿›åº¦:"
            echo "  1. âœ… CloudFlare webhook å·²è§¦å‘"
            echo "  2. â³ CloudFlare æ­£åœ¨ä»Ž gh-pages åˆ†æ”¯æž„å»º..."
            echo "  3. â³ æž„å»ºå®ŒæˆåŽå°†è‡ªåŠ¨éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ"
            echo "  4. â³ å…¨çƒ CDN ç¼“å­˜å°†åœ¨ 5-10 åˆ†é’Ÿå†…æ›´æ–°"
            echo ""
            echo "ðŸŒ è®¿é—®åœ°å€: https://martinliu.cn"
            echo "ðŸ’¡ æç¤º: è¯·ç­‰å¾…å‡ åˆ†é’ŸåŽéªŒè¯éƒ¨ç½²ç»“æžœ"
          else
            echo "ðŸ’¥ CloudFlare éƒ¨ç½²è§¦å‘å¤±è´¥ï¼"
            echo ""
            echo "ðŸ”§ æ•…éšœæŽ’æŸ¥å»ºè®®:"
            echo "  1. æ£€æŸ¥ CloudFlare webhook URL æ˜¯å¦æ­£ç¡®"
            echo "  2. éªŒè¯ CloudFlare Pages é¡¹ç›®é…ç½®"
            echo "  3. ç¡®è®¤ gh-pages åˆ†æ”¯æ˜¯å¦æœ€æ–°"
            echo "  4. è”ç³»ç®¡ç†å‘˜æ£€æŸ¥ CloudFlare æœåŠ¡çŠ¶æ€"
            echo ""
            echo "ðŸ”„ å¯ä»¥å°è¯•é‡æ–°æ‰‹åŠ¨è§¦å‘æ­¤å·¥ä½œæµ"
          fi

  deployment-guard:
    runs-on: ubuntu-latest
    # å½“ç”¨æˆ·æœªç¡®è®¤æ—¶æ‰§è¡Œï¼Œæä¾›è­¦å‘Šä¿¡æ¯
    if: ${{ inputs.confirm_production != true }}
    
    steps:
      - name: âš ï¸ éƒ¨ç½²ç¡®è®¤å¤±è´¥
        run: |
          echo "âš ï¸ éƒ¨ç½²å·²å–æ¶ˆ - æœªç¡®è®¤ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²"
          echo ""
          echo "ðŸ“‹ æäº¤çš„ä¿¡æ¯:"
          echo "  ðŸ“ éƒ¨ç½²åŽŸå› : ${{ inputs.deployment_reason }}"
          echo "  âœ… ç¡®è®¤éƒ¨ç½²: ${{ inputs.confirm_production }}"
          echo "  ðŸ‘¤ æ“ä½œäººå‘˜: ${{ github.actor }}"
          echo ""
          echo "ðŸ”’ å®‰å…¨æç¤º:"
          echo "  ä¸ºäº†å®‰å…¨èµ·è§ï¼Œå¿…é¡»æ˜Žç¡®ç¡®è®¤æ‰èƒ½éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ"
          echo "  è¯·é‡æ–°è¿è¡Œå·¥ä½œæµå¹¶å‹¾é€‰ 'ç¡®è®¤éƒ¨ç½²åˆ°ç”Ÿäº§çŽ¯å¢ƒ' é€‰é¡¹"
          echo ""
          echo "## âš ï¸ éƒ¨ç½²ç¡®è®¤å¤±è´¥" >> $GITHUB_STEP_SUMMARY
          echo "éƒ¨ç½²å·²å–æ¶ˆï¼Œå› ä¸ºæœªç¡®è®¤ç”Ÿäº§çŽ¯å¢ƒéƒ¨ç½²ã€‚" >> $GITHUB_STEP_SUMMARY
          echo "è¯·é‡æ–°è¿è¡Œå·¥ä½œæµå¹¶å‹¾é€‰ç¡®è®¤é€‰é¡¹ã€‚" >> $GITHUB_STEP_SUMMARY
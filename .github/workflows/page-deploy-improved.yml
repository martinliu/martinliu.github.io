name: ğŸš€ Deploy to CloudFlare Pages

on:
  push:
    branches: [master]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  
  # å¯é€‰ï¼šåœ¨ GitHub Pages éƒ¨ç½²å®Œæˆåè§¦å‘
  workflow_run:
    workflows: ["ğŸ—ï¸ Build & Deploy Preview to GitHub Pages"]
    types: [completed]
    branches: [master]

env:
  CF_HOOK_URL: "https://api.cloudflare.com/client/v4/pages/webhooks/deploy_hooks/b1b6b15d-b582-4304-bb0a-238b32bc3eb7"

jobs:
  trigger-cloudflare-deploy:
    runs-on: ubuntu-latest
    
    # åªåœ¨ master åˆ†æ”¯ä¸”å‰ç½®å·¥ä½œæµæˆåŠŸæ—¶è¿è¡Œ
    if: |
      github.ref == 'refs/heads/master' && 
      (github.event_name == 'push' || 
       github.event_name == 'workflow_dispatch' ||
       (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'))

    steps:
      - name: ğŸ”” Trigger CloudFlare Pages deployment
        id: cf-deploy
        run: |
          echo "ğŸš€ Triggering CloudFlare Pages deployment..."
          
          response=$(curl -s -w "%{http_code}" -X POST "${{ env.CF_HOOK_URL }}")
          http_code="${response: -3}"
          
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
            echo "âœ… CloudFlare deployment triggered successfully (HTTP $http_code)"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "âŒ CloudFlare deployment failed (HTTP $http_code)"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: ğŸ“Š Generate deployment report
        run: |
          echo "## ğŸš€ CloudFlare Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ steps.cf-deploy.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered at: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Production URL: https://martinliu.cn" >> $GITHUB_STEP_SUMMARY

      - name: ğŸ” Monitor deployment status (optional)
        continue-on-error: true
        run: |
          echo "â³ Waiting for CloudFlare deployment to complete..."
          sleep 30
          
          # å¯ä»¥æ·»åŠ å®é™…çš„çŠ¶æ€æ£€æŸ¥é€»è¾‘
          echo "âœ… Deployment monitoring completed"

  notify-success:
    needs: trigger-cloudflare-deploy
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: ğŸ‰ Deployment success notification
        run: |
          echo "ğŸ‰ Production deployment completed successfully!"
          echo "ğŸŒ Live site: https://martinliu.cn"

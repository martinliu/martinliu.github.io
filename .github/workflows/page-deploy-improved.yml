name: 🚀 Deploy to CloudFlare Pages

on:
  push:
    branches: [master]
  workflow_dispatch: # 允许手动触发
  
  # 可选：在 GitHub Pages 部署完成后触发
  workflow_run:
    workflows: ["🏗️ Build & Deploy Preview to GitHub Pages"]
    types: [completed]
    branches: [master]

env:
  CF_HOOK_URL: "https://api.cloudflare.com/client/v4/pages/webhooks/deploy_hooks/b1b6b15d-b582-4304-bb0a-238b32bc3eb7"

jobs:
  trigger-cloudflare-deploy:
    runs-on: ubuntu-latest
    
    # 只在 master 分支且前置工作流成功时运行
    if: |
      github.ref == 'refs/heads/master' && 
      (github.event_name == 'push' || 
       github.event_name == 'workflow_dispatch' ||
       (github.event_name == 'workflow_run' && github.event.workflow_run.conclusion == 'success'))

    steps:
      - name: 🔔 Trigger CloudFlare Pages deployment
        id: cf-deploy
        run: |
          echo "🚀 Triggering CloudFlare Pages deployment..."
          
          response=$(curl -s -w "%{http_code}" -X POST "${{ env.CF_HOOK_URL }}")
          http_code="${response: -3}"
          
          if [ "$http_code" -eq 200 ] || [ "$http_code" -eq 201 ]; then
            echo "✅ CloudFlare deployment triggered successfully (HTTP $http_code)"
            echo "status=success" >> $GITHUB_OUTPUT
          else
            echo "❌ CloudFlare deployment failed (HTTP $http_code)"
            echo "status=failed" >> $GITHUB_OUTPUT
            exit 1
          fi

      - name: 📊 Generate deployment report
        run: |
          echo "## 🚀 CloudFlare Deployment" >> $GITHUB_STEP_SUMMARY
          echo "- Status: ${{ steps.cf-deploy.outputs.status }}" >> $GITHUB_STEP_SUMMARY
          echo "- Triggered at: $(date)" >> $GITHUB_STEP_SUMMARY
          echo "- Branch: ${{ github.ref_name }}" >> $GITHUB_STEP_SUMMARY
          echo "- Commit: ${{ github.sha }}" >> $GITHUB_STEP_SUMMARY
          echo "- Production URL: https://martinliu.cn" >> $GITHUB_STEP_SUMMARY

      - name: 🔍 Monitor deployment status (optional)
        continue-on-error: true
        run: |
          echo "⏳ Waiting for CloudFlare deployment to complete..."
          sleep 30
          
          # 可以添加实际的状态检查逻辑
          echo "✅ Deployment monitoring completed"

  notify-success:
    needs: trigger-cloudflare-deploy
    runs-on: ubuntu-latest
    if: success()
    
    steps:
      - name: 🎉 Deployment success notification
        run: |
          echo "🎉 Production deployment completed successfully!"
          echo "🌐 Live site: https://martinliu.cn"
